<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <!-- DISABLE ZOOM -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>TF-Stream</title>
  <!-- PWA manifest et icônes -->
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/jpeg" href="https://files.catbox.moe/ixgmht.jpg" />
  <link rel="apple-touch-icon" href="https://files.catbox.moe/ixgmht.jpg" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* --- UI styles (unchanged) --- */
    body { margin:0; background:#000; color:#fff; font-family:'Roboto',sans-serif; overflow-x:hidden; padding-bottom:60px; }
    .header{padding:20px;text-align:center;position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(0,0,0,0.7);z-index:10;}
    .logo{font-size:28px;font-weight:bold;background:linear-gradient(90deg,#fff,#000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:blur(0.5px);}
    .filter-bar{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap;}
    .filter-btn{background:#222;color:#fff;border:none;padding:6px 14px;border-radius:30px;cursor:pointer;}
    .filter-btn.active{background:#444;}
    .search-container{display:flex;justify-content:center;padding:10px 20px;}
    .search-box{Width:100%;max-width:500px;background:#1c1c1e;border:none;padding:12px 20px;border-radius:15px;color:#fff;font-size:16px;box-shadow:inset 0 0 5px #000;outline:none;}
    .video-list{display:flex;flex-wrap:wrap;gap:15px;padding:20px;justify-content:center;min-height:200px;}
    .video-card{position:relative;width:110px;background:#111;border-radius:10px;overflow:hidden;cursor:pointer;transition:transform .2s;}
    .video-card:hover{transform:scale(1.03);}
    .video-card img{width:100%;display:block;}
    .card-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.6);opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity .3s;}
    .video-card:hover .card-overlay{opacity:1;}
    .play-icon{font-size:40px;color:#fff;}
    .info{padding:6px;text-align:center;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .nav-bar{position:fixed;bottom:0;width:100%;background:#111;display:flex;justify-content:space-around;padding:10px 0;z-index:20;border-top:1px solid #333;}
    .nav-btn{background:none;border:none;color:#aaa;font-size:14px;text-align:center;flex:1;cursor:pointer;}
    .nav-btn.active{color:#fff;font-weight:bold;}
    #explorerView{padding:20px;max-height:calc(100vh-120px);overflow-y:auto;display:none;background:#000;-webkit-overflow-scrolling:touch;min-height:200px;}
    .post-card{background:#111;border-radius:15px;padding:15px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.7);} 
    .post-name{font-weight:700;font-size:17px;margin-bottom:8px;color:#fff;}
    .post-text{font-size:15px;color:#ddd;margin-bottom:10px;white-space:pre-wrap;}
    .social-section{margin-top:10px;padding-top:10px;border-top:1px solid #333;display:flex;justify-content:center;gap:15px;}
    .social-section img{width:40px;height:40px;}
    .overlay-fond{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:none;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto;z-index:999;}
    .modal-container{background:#111;border-radius:10px;padding:20px;max-width:700px;width:100%;box-shadow:0 4px 20px rgba(0,0,0,0.8);position:relative;}
    .modal-container button{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
    .thumbnail{width:auto;max-width:100%;height:auto;max-height:70vh;object-fit:contain;border-radius:6px;margin-bottom:12px;}
    .modal-title{font-size:24px;font-weight:700;margin-bottom:8px;}
    .modal-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .season-list{position:absolute;top:60px;right:20px;background:#111;border-radius:6px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.7);display:none;z-index:1001;}
    .season-list button{width:100%;padding:10px;text-align:left;background:#222;color:#fff;border:none;border-bottom:1px solid #333;cursor:pointer;}
    .modal-info{background:#111;border-radius:6px;padding:12px;font-size:14px;color:#ddd;margin-bottom:12px;display:none;}
    .modal-episodes{display:grid;grid-template-columns:1fr;gap:10px;}
    .episode-item{background:rgba(0,0,0,0.6);padding:12px;border-radius:8px;cursor:pointer;transition:transform .2s;}
    .episode-item:hover{transform:scale(1.02);}
    .episode-item.active { background: rgba(200,200,200,0.3); }
    .episode-item.visited { background: rgba(50,50,50,0.4); color: #aaa; font-weight: normal; }
    .ad-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:1000;}
    .ad-container{background:#111;padding:20px;border-radius:10px;text-align:center;}
    .ad-container button{background:#444;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;}
    /* splash */
    #splash { position: fixed; inset:0; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; animation: splashPop 1.7s forwards; }
    .splash-logo { font-size:3rem; font-weight:bold; background:linear-gradient(90deg,#fff,#000); -webkit-background-clip:text; -webkit-text-fill-color:transparent; filter: blur(0.5px); margin:0; animation:logoPop 1.7s ease-out forwards; }
    .splash-version { margin-top:0.5rem; color:#aaa; font-size:1rem; animation:logoPop 1.7s ease-out forwards; }
    @keyframes splashPop { 0%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
    @keyframes logoPop { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.2)} 80%{transform:scale(1.1)} 100%{opacity:0;transform:scale(1.1)} }

    /* ==== ADJUSTED: allow original image/video size, preserve aspect ratio (no crop) ==== */
    .media-container { width:100%; height:auto; overflow:visible; padding:6px 0; background:transparent; display:flex; justify-content:center; align-items:center; }
    .media-container img, .media-container video { width:auto; height:auto; max-width:100%; max-height:80vh; object-fit:contain; display:block; margin:0 auto; border-radius:8px; }

    /* Explorer specific (keeps image/video inside post cards at natural size) */
    .post-card .media-container { padding:6px 0; }
    .post-card .media-container img { width:auto; height:auto; max-width:100%; max-height:360px; object-fit:contain; display:block; margin:0 auto; }
    .post-card .media-container video { width:auto; height:auto; max-width:100%; max-height:480px; object-fit:contain; display:block; border-radius:8px; }

    /* Explorer-created video class */
    .explorer-video { width:auto; max-width:100%; height:auto; max-height:480px; object-fit:contain; border-radius:8px; display:block; margin:0 auto; }

    /* === DISABLE TEXT SELECTION & BLOCK CONTEXT MENU (user cannot copy) === */
    * { -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; user-select: none !important; }
    input, textarea, select, .search-box { -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; user-select: text !important; }
    body, html { -webkit-touch-callout: none; }
    ::-webkit-scrollbar { display: none; } /* hide scrollbar visuals while keeping scroll functional */
    html { scrollbar-width: none; -ms-overflow-style: none; }
  </style>
</head>
<body>
  <!-- Splash -->
  <div id="splash">
    <h1 class="splash-logo">TF-Stream</h1>
    <p class="splash-version">D'H7 | Tergene</p>
  </div>

  <!-- Overlay modal container -->
  <div id="fondOverlay" class="overlay-fond" aria-hidden="true"></div>

  <div class="header" id="mainHeader">
    <div class="logo">TF-Stream</div>
    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterCategory('Tout',event)">Tout</button>
      <button class="filter-btn" onclick="filterCategory('Film',event)">Film</button>
      <button class="filter-btn" onclick="filterCategory('Série',event)">Série</button>
      <button class="filter-btn" onclick="filterCategory('Anime',event)">Anime</button>
    </div>
    <div class="search-container">
      <input id="searchBox" class="search-box" type="text" placeholder="Rechèch..." autocomplete="off">
    </div>
  </div>

  <div class="video-list" id="videoList"></div>
  <div id="explorerView"></div>

  <div class="nav-bar">
    <button class="nav-btn active" onclick="navigateTo('Accueil',event)">Accueil</button>
    <button class="nav-btn" onclick="navigateTo('Explorer',event)">Explorer</button>
  </div>

  <div id="adOverlay" class="ad-overlay">
    <div class="ad-container">
      <p>Publicité</p>
      <button id="adLinkBtn">En savoir plus</button>
      <button onclick="closeAd()">Fermer</button>
    </div>
  </div>

<script>
  // silence console warnings/errors
  console.warn = function(){};
  console.error = function(){};

  // helpers
  function slugify(text){
    return String(text||'').toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
      .replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-');
  }
  function shuffleArray(arr){
    for(let i=arr.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  // social/ad
  const socialLinks = {
    whatsapp: "https://whatsapp.com/channel/0029VbB3DwvLtOjCUY4RaK39",
    instagram: "https://www.instagram.com/tfstream7?igsh=ZmE2OHB3MjU5NWY3&utm_source=ig_contact_invite",
    facebook: "https://www.facebook.com/profile.php?id=61578064777470",
    youtube: "https://www.youtube.com/@TFStream7",
    gmail: "mailto:tfstream7@gmail"
  };
  const adUrl = "https://pantherinvincible.com/yqsqxk5wu0?key=60a527bb6c037e8d6ce7469648b76dcb";

  // DOM
  const videoListEl = document.getElementById('videoList');
  const explorerEl = document.getElementById('explorerView');
  const overlay = document.getElementById('fondOverlay');
  const searchBox = document.getElementById('searchBox');
  const mainHeader = document.getElementById('mainHeader');

  // prevent copy + right-click context menu (user asked cannot copy)
  document.addEventListener('copy', (e) => { e.preventDefault(); });
  document.addEventListener('contextmenu', (e) => { e.preventDefault(); });

  // click outside modal closes
  overlay.addEventListener('click', (e) => {
    if(e.target === overlay) {
      location.hash = 'Accueil';
      closeModal();
    }
  });

  // local helpers for localStorage
  function readState(key){
    try { return JSON.parse(localStorage.getItem(key) || '{}'); }
    catch(e){ return {}; }
  }
  function writeState(key, obj){
    try { localStorage.setItem(key, JSON.stringify(obj)); }
    catch(e) { /* silent */ }
  }

  // IndexedDB for uploads
  function openDB(){
    return new Promise((resolve, reject) => {
      const req = indexedDB.open('tfStream', 1);
      req.onupgradeneeded = () => {
        const db = req.result;
        if(!db.objectStoreNames.contains('uploads')){
          db.createObjectStore('uploads', { keyPath: 'id', autoIncrement: true });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }
  function addUpload(obj){
    return openDB().then(db => new Promise((res, rej)=>{
      const tx = db.transaction('uploads', 'readwrite');
      const store = tx.objectStore('uploads');
      store.add(obj);
      tx.oncomplete = ()=>{ db.close(); res(true); };
      tx.onerror = ()=>{ db.close(); rej(tx.error); };
    }));
  }
  function getAllUploads(){
    return openDB().then(db => new Promise((res, rej)=>{
      const tx = db.transaction('uploads','readonly');
      const store = tx.objectStore('uploads');
      const req = store.getAll();
      req.onsuccess = ()=>{ db.close(); res(req.result || []); };
      req.onerror = ()=>{ db.close(); rej(req.error); };
    }));
  }
  function clearUploadsDB(){
    return new Promise((resolve)=>{
      const del = indexedDB.deleteDatabase('tfStream');
      del.onsuccess = ()=> resolve(true);
      del.onerror = ()=> resolve(false);
      del.onblocked = ()=> resolve(false);
    });
  }

  // global dataset & slug map
  window.allData = [];
  window.slugMap = {};

  // load data (index.json + optional referenced files) + merge uploads
  (function loadData(){
    fetch('index.json').then(r=>{
      if(!r.ok) throw new Error('index.json not ok');
      return r.json();
    }).then(files => {
      return Promise.all(files.map(f => fetch(f).then(res => res.ok ? res.json() : null).catch(()=>null)));
    }).then(jsons => {
      jsons.forEach(d => {
        if(!d) return;
        if(Array.isArray(d)) window.allData.push(...d);
        else window.allData.push(d);
      });
      return getAllUploads().catch(()=>[]);
    }).then(uploads=>{
      (uploads||[]).forEach(u=>{
        const item = {
          Titre: u.title || ('Upload '+(u.id||'')),
          Name: u.title || ('Upload '+(u.id||'')),
          Catégorie: 'poste',
          Url: u.url || '',
          'Url Thumb': u.thumb || '',
          Description: u.description || '',
          uploaded:true,
          __uploadedId: u.id
        };
        window.allData.unshift(item);
      });
      if(window.allData.length === 0 && window.sampleData) window.allData = sampleData.slice();
      prepareSlugMap();
      shuffleArray(window.allData);
      if(!location.hash) location.replace('Accueil');
      handleHash(location.hash);
    }).catch(err=>{
      // fallback: load uploads only if present
      getAllUploads().then(uploads=>{
        (uploads||[]).forEach(u=>{
          const item = { Titre:u.title||('Upload '+(u.id||'')), Name:u.title||('Upload '+(u.id||'')), Catégorie:'poste', Url:u.url||'', 'Url Thumb':u.thumb||'', Description:u.description||'', uploaded:true, __uploadedId:u.id };
          window.allData.unshift(item);
        });
        prepareSlugMap(); shuffleArray(window.allData); if(!location.hash) location.replace('Accueil'); handleHash(location.hash);
      }).catch(()=>{
        if(window.sampleData) window.allData = sampleData.slice();
        prepareSlugMap(); shuffleArray(window.allData); if(!location.hash) location.replace('Accueil'); handleHash(location.hash);
      });
    });
  })();

  function prepareSlugMap(){
    window.slugMap = {};
    window.allData.forEach((it, i) => {
      const title = it.Titre || it.Name || it.Title || it['Nom'] || ('item-'+i);
      const base = slugify(title);
      let slug = base || ('item-'+i);
      let k = 1;
      while(window.slugMap[slug]) { slug = base + '-' + k; k++; }
      window.slugMap[slug] = { item: it, index: i, slug: slug };
      it.__slug = slug;
    });
  }

  // display accueil
  function displayVideos(videos){
    videoListEl.innerHTML = '';
    const activeBtn = document.querySelector('.filter-btn.active');
    const cat = activeBtn ? activeBtn.textContent.toLowerCase() : 'tout';

    let visible = videos.filter(v => {
      const c = (v.Catégorie || v.category || '').toLowerCase();
      if(c === 'poste') return false;
      if(cat === 'tout') return true;
      if(cat === 'film' && c === 'film') return true;
      if(cat === 'série' && (c === 'série' || c === 'serie')) return true;
      if(cat === 'anime' && (c === 'anime' || c === 'animé')) return true;
      return false;
    });

    shuffleArray(visible);

    if(visible.length === 0){
      videoListEl.innerHTML = '<div style="color:#888;width:100%;text-align:center;padding:60px 0"> </div>';
      return;
    }

    visible.forEach((v) => {
      const card = document.createElement('div');
      card.className = 'video-card';
      card.innerHTML = `
        <img src="${v['Url Thumb'] || 'https://placehold.co/300x180?text=no+thumb'}" alt="">
        <div class="card-overlay"><span class="play-icon">▶</span></div>
        <div class="info">${v.Titre || v.Name || v.Texte || 'Sans titre'}</div>
      `;
      card.addEventListener('click', () => {
        const slug = v.__slug || slugify(v.Titre||v.Name||'');
        location.hash = slug;
      });
      videoListEl.appendChild(card);
    });
  }

  // Explorer (poste items)
  function displayExplorer(){
    explorerEl.innerHTML = '';
    let posts = window.allData.filter(p => (p.Catégorie || p.category || '').toString().toLowerCase() === 'poste');
    shuffleArray(posts);

    if(posts.length === 0){
      explorerEl.innerHTML = '<div style="color:#888;width:100%;text-align:center;padding:60px 0"> </div>';
      return;
    }

    posts.forEach(post => {
      const thumbUrl = post['Url Thumb'] || '';
      const videoUrl = post.Previously || post['Previously '] || post.video || post.Url || '';
      const card = document.createElement('div');
      card.className = 'post-card';
      card.innerHTML = `
        <div class="media-container">
          <img class="thumb" src="${thumbUrl || 'https://placehold.co/600x360?text=no+thumb'}" alt="">
        </div>
        <div class="post-name">${post.Name || post.Titre || ''}</div>
        <div class="post-text">${post.Description || post.Bio || ''}</div>
      `;
      explorerEl.appendChild(card);

      // do not open modal on explorer cards
      card.addEventListener('click', (e) => { e.stopPropagation(); });

      // clicking image -> insert native video element (user must press play if browser blocks autoplay with sound)
      const thumb = card.querySelector('.thumb');
      if(thumb){
        thumb.style.cursor = videoUrl ? 'pointer' : 'default';
        thumb.addEventListener('click', (e) => {
          e.stopPropagation();
          if(!videoUrl) return;
          const media = card.querySelector('.media-container');
          if(media.querySelector('video')) return;
          const v = document.createElement('video');
          v.src = videoUrl;
          v.controls = true;
          v.autoplay = false; // allow user to start with sound
          v.playsInline = true;
          v.muted = false; // allow audio when user presses play
          v.className = 'explorer-video';
          media.innerHTML = '';
          media.appendChild(v);
          v.focus && v.focus();
        }, {passive:true});
      }

      // swipe to play (kept)
      if(videoUrl){
        let startX = 0;
        card.addEventListener('touchstart', e => startX = e.changedTouches[0].clientX, {passive:true});
        card.addEventListener('touchend', e => {
          const endX = e.changedTouches[0].clientX;
          if(Math.abs(endX - startX) > 50){
            const media = card.querySelector('.media-container');
            if(media.querySelector('video')) return;
            media.innerHTML = `<video class="explorer-video" src="${videoUrl}" controls playsinline></video>`;
          }
        }, {passive:true});
      }
    });

    displaySocialLinks();
  }

  function displaySocialLinks(){
    const existing = explorerEl.querySelector('.social-section');
    if(existing) existing.remove();
    const s = document.createElement('div');
    s.className = 'social-section';
    s.innerHTML = `
      <a href="${socialLinks.facebook}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=118467&format=png&color=ffffff"/></a>
      <a href="${socialLinks.gmail}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=Y2GfpkgYNp42&format=png&color=ffffff"/></a>
      <a href="${socialLinks.whatsapp}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=16733&format=png&color=ffffff"/></a>
      <a href="${socialLinks.instagram}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=32309&format=png&color=ffffff"/></a>
      <a href="${socialLinks.youtube}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=37326&format=png&color=ffffff"/></a>
    `;
    explorerEl.appendChild(s);
  }

  // filters & navigation
  function filterCategory(_, e){
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    shuffleArray(window.allData);
    displayVideos(window.allData);
    location.hash = 'Accueil';
  }

  function filterSearch(val){
    const results = window.allData.filter(i => (i.Titre||i.Name||i.Texte||'').toLowerCase().includes(val.toLowerCase()));
    shuffleArray(results);
    displayVideos(results);
    location.hash = 'search';
  }

  function navigateTo(sec, e){
    shuffleArray(window.allData);
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    if(e && e.target) e.target.classList.add('active');

    videoListEl.style.display = 'none';
    explorerEl.style.display = 'none';
    document.querySelector('.filter-bar').style.display = 'none';
    document.querySelector('.search-container').style.display = 'none';

    if(sec === 'Accueil'){
      displayVideos(window.allData);
      videoListEl.style.display = 'flex';
      document.querySelector('.filter-bar').style.display = 'flex';
      document.querySelector('.search-container').style.display = 'flex';
      location.hash = 'Accueil';
    } else {
      displayExplorer();
      explorerEl.style.display = 'block';
      document.querySelector('.search-container').style.display = 'flex';
      location.hash = 'Explorer';
    }
  }

  // modal with hash handling
  function showPostModal(post, postIndex, opts = { push: true }){
    const slug = post.__slug || slugify((post.Titre||post.Name||('item-'+postIndex)));
    overlay.innerHTML = `
      <div class="modal-container" role="dialog" aria-modal="true">
        <button id="modalBackBtn">← Retour</button>

        <div class="media-container" id="mediaWrap">
          <img id="modalImg" class="thumbnail" src="${post['Url Thumb'] || ''}" alt="poster">
          <video id="modalVideo" class="thumbnail" style="display:none;" muted controls playsinline controlsList="nodownload"></video>
        </div>

        <div id="modalTitle" class="modal-title"></div>
        <div class="modal-controls">
          <button id="infoBtn">Voir plus…</button>
          <button id="seasonBtn">Saison 1</button>
        </div>
        <div id="seasonList" class="season-list"></div>
        <div id="modalInfo" class="modal-info"></div>
        <div id="episodeList" class="modal-episodes"></div>
      </div>
    `;
    overlay.style.display = 'flex';
    overlay.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';

    const modalImg   = document.getElementById('modalImg'),
          modalVideo = document.getElementById('modalVideo'),
          titleEl    = document.getElementById('modalTitle'),
          infoBtn    = document.getElementById('infoBtn'),
          seasonBtn  = document.getElementById('seasonBtn'),
          seasonList = document.getElementById('seasonList'),
          infoEl     = document.getElementById('modalInfo'),
          epList     = document.getElementById('episodeList'),
          saisons    = post.Saisons || post.Seasons || [];

    titleEl.textContent = post.Titre || post.Name || '';

    const storageKey = `post-${slug}-state`;
    const saved = readState(storageKey) || {};
    let playbackTimes = saved.playbackTimes || {};
    let visited = saved.visited || {};
    let currentSeason = 0, selectedEpEl = null;

    function saveState(){
      const last = (modalVideo.style.display !== 'none' && modalVideo.src) ? modalVideo.src : (saved.lastVideoUrl || '');
      writeState(storageKey, { lastVideoUrl: last, playbackTimes, visited });
    }

    function renderInfo(){
      const s = saisons[currentSeason] || {};
      infoEl.innerHTML = `<strong>Description:</strong> ${s.description||''}<br><strong>Bio:</strong> ${s.bio||''}<br><strong>Info:</strong> ${s.info||''}`;
      infoEl.style.display = 'block';
    }

    infoBtn.onclick = () => infoEl.style.display = infoEl.style.display === 'block' ? 'none' : 'block';

    seasonList.innerHTML = '';
    (saisons || []).forEach((s, i) => {
      const b = document.createElement('button');
      b.textContent = `Saison ${i+1}`;
      b.onclick = () => {
        currentSeason = i;
        seasonBtn.textContent = `Saison ${i+1}`;
        renderInfo(); renderEpisodes();
        seasonList.style.display = 'none';
      };
      seasonList.appendChild(b);
    });
    if(!saisons || saisons.length === 0) seasonBtn.style.display = 'none';
    else seasonBtn.style.display = 'inline-block';
    seasonBtn.onclick = () => seasonList.style.display = seasonList.style.display === 'block' ? 'none' : 'block';

    function activateVideo(src, episodeThumb){
      try { window.open(adUrl, '_blank'); } catch(e){}
      if(modalVideo && modalVideo.src){
        playbackTimes[modalVideo.src] = Math.max(0, modalVideo.currentTime || 0);
      }
      if(episodeThumb) modalImg.src = episodeThumb;
      modalImg.style.display = 'none';
      modalVideo.style.display = 'block';
      modalVideo.pause();
      modalVideo.src = src;
      modalVideo.load();
      modalVideo.muted = false;
      const restoreTime = () => {
        try {
          if (playbackTimes[src]) modalVideo.currentTime = playbackTimes[src];
          else modalVideo.currentTime = 0;
        } catch(e){}
        modalVideo.removeEventListener('loadedmetadata', restoreTime);
      };
      modalVideo.addEventListener('loadedmetadata', restoreTime);
      const p = modalVideo.play();
      if(p && p.catch) p.catch(()=>{});
    }

    function activateImage(poster){
      if(modalVideo && modalVideo.src){
        playbackTimes[modalVideo.src] = Math.max(0, modalVideo.currentTime || 0);
      }
      try { modalVideo.pause(); } catch(e){}
      modalVideo.removeAttribute('src');
      modalVideo.load();
      modalVideo.style.display = 'none';
      modalImg.style.display = 'block';
      if(poster) modalImg.src = poster;
      saveState();
    }

    function renderEpisodes(){
      epList.innerHTML = '';
      const eps = (saisons[currentSeason] && saisons[currentSeason].episodes) || [];
      eps.forEach((ep, i) => {
        const d = document.createElement('div');
        d.className = 'episode-item';
        d.innerHTML = `<strong>Episode ${i+1}</strong><div>${ep.description||''}</div>`;
        const visKey = ep.video || ep.url || ('ep-'+i);
        if(visited[visKey]) d.classList.add('visited');

        d.onclick = () => {
          if(selectedEpEl) selectedEpEl.classList.remove('active');
          d.classList.add('active');
          selectedEpEl = d;

          const newSrc = ep.video || ep.url || ep.stream || '';
          if(!newSrc) return;

          activateVideo(newSrc, ep.thumb || post['Url Thumb'] || '');

          const onTime = () => {
            if(modalVideo.currentTime > 7){
              d.classList.add('visited');
              visited[visKey] = true;
              modalVideo.removeEventListener('timeupdate', onTime);
              saveState();
            }
          };
          modalVideo.addEventListener('timeupdate', onTime);
          saveState();
        };

        epList.appendChild(d);
      });
    }

    renderInfo();
    renderEpisodes();

    if(saved && saved.lastVideoUrl){
      let found = false;
      for(let si=0; si < (saisons.length || 0) && !found; si++){
        const eps = (saisons[si] && saisons[si].episodes) || [];
        for(let ei=0; ei < eps.length; ei++){
          if(eps[ei] && (eps[ei].video === saved.lastVideoUrl || eps[ei].url === saved.lastVideoUrl)){
            currentSeason = si;
            seasonBtn.textContent = `Saison ${si+1}`;
            renderInfo(); renderEpisodes();
            const el = epList.children[ei];
            if(el) { el.click(); found = true; break; }
          }
        }
      }
      if(!found){
        const url = saved.lastVideoUrl;
        if(url && (url.match(/\.(mp4|webm|m3u8|mpd)(\?|$)/i) || url.startsWith('blob:') || url.startsWith('http'))){
          activateVideo(url, post['Url Thumb'] || '');
          const restoreTime2 = () => {
            try {
              if (saved.playbackTimes && saved.playbackTimes[url]) {
                modalVideo.currentTime = saved.playbackTimes[url];
              } else {
                modalVideo.currentTime = 0;
              }
            } catch(e) {}
            modalVideo.removeEventListener('loadedmetadata', restoreTime2);
          };
          modalVideo.addEventListener('loadedmetadata', restoreTime2);
        } else {
          activateImage(post['Url Thumb'] || '');
        }
      }
    } else {
      modalImg.style.display = 'block';
      modalVideo.style.display = 'none';
    }

    if(opts.push !== false){
      if(location.hash.replace(/^#/,'') !== slug) location.hash = slug;
    } else {
      location.replace(location.pathname + '#' + slug);
    }

    document.getElementById('modalBackBtn').onclick = () => {
      try { modalVideo.pause(); } catch(e){}
      activateImage(post['Url Thumb'] || '');
      location.hash = 'Accueil';
    };
  }

  function closeModal(){
    overlay.style.display = 'none';
    overlay.innerHTML = '';
    overlay.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  function closeAd(){ document.getElementById('adOverlay').style.display = 'none'; }

  // hash routing
  function handleHash(raw){
    const hRaw = String(raw || location.hash || '').replace(/^#/,'' );
    const h = (hRaw || '').toString().toLowerCase();

    if(!h || h === 'accueil'){
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.nav-btn')[0]?.classList.add('active');
      document.querySelector('.filter-bar').style.display = 'flex';
      document.querySelector('.search-container').style.display = 'flex';
      displayVideos(window.allData);
      videoListEl.style.display = 'flex';
      explorerEl.style.display = 'none';
      closeModal();
      return;
    }
    if(h === 'explorer' || h === 'explore'){
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.nav-btn')[1]?.classList.add('active');
      document.querySelector('.filter-bar').style.display = 'none';
      document.querySelector('.search-container').style.display = 'flex';
      displayExplorer();
      explorerEl.style.display = 'block';
      videoListEl.style.display = 'none';
      closeModal();
      return;
    }
    if(h === 'search'){
      closeModal();
      return;
    }
    const slug = hRaw;
    const info = window.slugMap[slug] || window.slugMap[slug.toLowerCase()];
    if(info && info.item){
      showPostModal(info.item, info.index, { push:false });
    } else {
      closeModal();
      displayVideos(window.allData);
      videoListEl.style.display = 'flex';
      explorerEl.style.display = 'none';
    }
  }

  window.addEventListener('hashchange', ()=> handleHash(location.hash));

  function handleInitialHashOnLoad(){
    setTimeout(()=>{ handleHash(location.hash); }, 200);
  }
  window.addEventListener('load', handleInitialHashOnLoad);

  // service worker registration (kept)
  window.addEventListener('load', () => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js', { scope: '/' })
        .then(reg => {
          navigator.serviceWorker.ready.then(regReady => {
            if (regReady.active && regReady.active.postMessage) {
              regReady.active.postMessage({ type: 'LIST_CACHES' });
            }
          });
        })
        .catch(()=>{/* silent */});

      navigator.serviceWorker.addEventListener('message', ()=>{/* silent */});
    }
  });

  // remove splash after animation
  setTimeout(() => {
    const splash = document.getElementById('splash');
    if (splash) splash.remove();
  }, 1700);

  // SEARCH commands: /register, /record, /myuploads
  searchBox.addEventListener('keydown', function(e){
    if(e.key === 'Enter'){
      const val = this.value.trim();
      if(val === '') return;
      if(val.toLowerCase().startsWith('/register')){ showRegisterModal(); this.value=''; return; }
      if(val.toLowerCase().startsWith('/record')){ showRecorderModal(); this.value=''; return; }
      if(val.toLowerCase().startsWith('/myuploads')){
        navigateTo('Explorer');
        const uploads = window.allData.filter(i=>i.uploaded);
        explorerEl.innerHTML = '';
        if(uploads.length === 0){ explorerEl.innerHTML = '<div style="color:#888;width:100%;text-align:center;padding:60px 0">Pa gen upload ankò.</div>'; this.value=''; return; }
        uploads.forEach(post=>{ const card = document.createElement('div'); card.className='post-card'; card.innerHTML = `<div class="media-container"><img class="thumb" src="${post['Url Thumb']||'https://placehold.co/600x360?text=no+thumb'}"/></div><div class="post-name">${post.Name||post.Titre||''}</div><div class="post-text">${post.Description||''}</div>`; explorerEl.appendChild(card); });
        this.value=''; return;
      }
      // normal search
      filterSearch(val);
    }
  });

  searchBox.addEventListener('input', function(){
    const v = this.value || '';
    if(v.startsWith('/')) return; // commands handled on Enter
    filterSearch(v);
  });

  // Registration modal
  function showRegisterModal(){
    overlay.innerHTML = `
      <div class="modal-container" role="dialog" aria-modal="true">
        <h2 class="modal-title">Enregistré - TF-Stream</h2>
        <label>Non (display):</label>
        <input id="reg_name" type="text" placeholder="Non" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:none;background:#222;color:#fff;">
        <label>Email:</label>
        <input id="reg_email" type="email" placeholder="Email" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:none;background:#222;color:#fff;">
        <label>Mot de passe:</label>
        <input id="reg_pass" type="password" placeholder="****" style="width:100%;padding:8px;margin:6px 0;border-radius:6px;border:none;background:#222;color:#fff;">
        <div style="display:flex;gap:8px;margin-top:12px;"><button id="regSaveBtn">Enregistré</button><button id="regCancel">Annulé</button></div>
        <p style="color:#999;margin-top:8px;font-size:13px;">Remak: Done yo sere lokalman nan browser (localStorage).</p>
      </div>`;
    overlay.style.display = 'flex'; overlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';

    document.getElementById('regCancel').onclick = closeModal;
    document.getElementById('regSaveBtn').onclick = ()=>{
      const name = document.getElementById('reg_name').value.trim();
      const email = document.getElementById('reg_email').value.trim();
      const pass = document.getElementById('reg_pass').value;
      if(!name || !email || !pass){ alert('Ranpli tout chan yo.'); return; }
      const users = JSON.parse(localStorage.getItem('tf_users')||'[]');
      users.push({name,email,pass,created:Date.now()});
      localStorage.setItem('tf_users', JSON.stringify(users));
      localStorage.setItem('tf_current_user', JSON.stringify({name,email}));
      closeModal();
      alert('Enregistrement fini. Ou konekte kòm '+name);
    };
  }

  // Recorder modal (video+audio)
  function showRecorderModal(){
    overlay.innerHTML = `
      <div class="modal-container" role="dialog" aria-modal="true">
        <h2 class="modal-title">Enregistrement vidéo</h2>
        <div style="display:flex;gap:8px;flex-direction:column;">
          <video id="recPreview" autoplay playsinline muted style="width:100%;height:auto;background:#000;border-radius:8px;"></video>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;">
            <button id="startRec">Start</button>
            <button id="stopRec" disabled>Stop</button>
            <button id="saveRec" disabled>Sauvegarder</button>
            <button id="cancelRec">Annulé</button>
          </div>
          <input id="recTitle" placeholder="Titre video" style="width:100%;padding:8px;margin-top:8px;border-radius:6px;border:none;background:#222;color:#fff;" />
          <textarea id="recDesc" placeholder="Description" style="width:100%;padding:8px;margin-top:8px;border-radius:6px;border:none;background:#222;color:#fff;height:70px;"></textarea>
        </div>
      </div>`;
    overlay.style.display = 'flex'; overlay.setAttribute('aria-hidden','false'); document.body.style.overflow='hidden';

    const preview = document.getElementById('recPreview');
    const startBtn = document.getElementById('startRec');
    const stopBtn = document.getElementById('stopRec');
    const saveBtn = document.getElementById('saveRec');
    const cancelBtn = document.getElementById('cancelRec');
    const titleInput = document.getElementById('recTitle');
    const descInput = document.getElementById('recDesc');

    let stream = null; let recorder = null; let chunks = [];

    async function startStream(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ audio:true, video:true });
        preview.srcObject = stream; preview.muted = true;
        recorder = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp8,opus' });
        chunks = [];
        recorder.ondataavailable = e => { if(e.data && e.data.size) chunks.push(e.data); };
        recorder.onstop = ()=>{ saveBtn.disabled = false; stopBtn.disabled = true; startBtn.disabled = false; };
        recorder.start();
        startBtn.disabled = true; stopBtn.disabled = false; saveBtn.disabled = true;
      }catch(err){ alert('Pa jwenn kamera/mikwo: ' + (err.message||err)); }
    }

    function stopStream(){
      if(recorder && recorder.state !== 'inactive') recorder.stop();
      if(stream){ stream.getTracks().forEach(t=>t.stop()); }
      preview.srcObject = null;
    }

    async function saveRecording(){
      const blob = new Blob(chunks, { type: 'video/webm' });
      const url = URL.createObjectURL(blob);
      const title = titleInput.value.trim() || ('Upload '+Date.now());
      const desc = descInput.value.trim() || '';
      const toStore = { title, description:desc, blob, url, created:Date.now() };
      try{
        await addUpload(toStore);
        alert('Video sauvegardée localman. Ale Explorer pou wè li.');
        const item = { Titre:title, Name:title, Catégorie:'poste', Url:url, 'Url Thumb':'', Description:desc, uploaded:true };
        window.allData.unshift(item); prepareSlugMap(); navigateTo('Explorer');
        closeModal();
      }catch(e){ alert('Echwe sove: '+(e.message||e)); }
    }

    startBtn.onclick = startStream;
    stopBtn.onclick = ()=>{ stopStream(); stopBtn.disabled = true; startBtn.disabled = false; saveBtn.disabled = false; };
    saveBtn.onclick = saveRecording;
    cancelBtn.onclick = ()=>{ stopStream(); closeModal(); };
  }

  // header click -> clear local data + reload
  mainHeader.addEventListener('click', (e)=>{
    const tag = e.target.tagName.toLowerCase();
    if(['input','button','textarea','select','a'].includes(tag)) return;
    try{ localStorage.clear(); sessionStorage.clear(); }catch(e){}
    clearUploadsDB().then(()=>{ location.reload(); }).catch(()=>{ location.reload(); });
  });
</script>
  <script type='text/javascript' src='//pantherinvincible.com/64/68/83/6468839024f881b57715852274ce968b.js'></script>
</body>
  </html>

