<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>TF-Stream</title>
  <link rel="manifest" href="/manifest.json?v=2">
  <link rel="icon" type="image/jpeg" href="https://pub-46b5efc7a2f74e6797b554c867465fc0.r2.dev/1761363481529-ixgmht.jpg" />
  <link rel="apple-touch-icon" href="https://pub-46b5efc7a2f74e6797b554c867465fc0.r2.dev/1761363481529-ixgmht.jpg" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* === UI inchangée (copie de ton style) === */
    :root{ --thumb-w: clamp(90px, 14vw, 160px); --thumb-aspect: calc(9/16); --thumb-h: calc(var(--thumb-w) * var(--thumb-aspect)); --thumb-radius: 10px; --card-gap: 15px; }
    html, body { overscroll-behavior: none; touch-action: pan-y; }
    body { margin:0; background:#000; color:#fff; font-family:'Roboto',sans-serif; overflow-x:hidden; padding-bottom:60px; }
    .header{padding:20px;text-align:center;position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(0,0,0,0.7);z-index:10;}
    .logo{font-size:28px;font-weight:bold;background:linear-gradient(90deg,#fff,#000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:blur(0.5px);}
    .filter-bar{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap;}
    .filter-btn{background:#222;color:#fff;border:none;padding:6px 14px;border-radius:30px;cursor:pointer;}
    .filter-btn.active{background:#444;}
    .search-container{display:flex;justify-content:center;padding:10px 20px;}
    .search-box{width:100%;max-width:500px;background:#1c1c1e;border:none;padding:12px 20px;border-radius:15px;color:#fff;font-size:16px;box-shadow:inset 0 0 5px #000;outline:none;}
    .video-list{display:flex;flex-wrap:wrap;gap:var(--card-gap);padding:20px;justify-content:center;min-height:200px;}
    .video-card{position:relative;width:var(--thumb-w);background:#111;border-radius:8px;overflow:visible;cursor:pointer;transition:transform .18s;display:flex;flex-direction:column;align-items:stretch;}
    .video-card:hover{transform:scale(1.03);}
    .thumb-wrap{width:100%;height:var(--thumb-h);overflow:hidden;border-radius:var(--thumb-radius);background:#111;display:block;}
    .thumb-wrap img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;transform-origin:center center;}
    .card-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity .25s;border-radius:8px;}
    .video-card:hover .card-overlay{opacity:1;}
    .play-icon{font-size:40px;color:#fff;}
    .info{padding:6px;text-align:center;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .nav-bar{position:fixed;bottom:0;width:100%;background:#111;display:flex;justify-content:space-around;padding:10px 0;z-index:20;border-top:1px solid #333;}
    .nav-btn{background:none;border:none;color:#aaa;font-size:14px;text-align:center;flex:1;cursor:pointer;}
    .nav-btn.active{color:#fff;font-weight:bold;}
    #explorerView{padding:20px;max-height:calc(100vh-120px);overflow-y:auto;display:none;background:#000;-webkit-overflow-scrolling:touch;min-height:200px;}
    .post-card{background:#111;border-radius:15px;padding:15px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.7);}   
    .post-name{font-weight:700;font-size:17px;margin-bottom:8px;color:#fff;}
    .post-text{font-size:15px;color:#ddd;margin-bottom:10px;white-space:pre-wrap;}
    .social-section{margin-top:10px;padding-top:10px;border-top:1px solid #333;display:flex;justify-content:center;gap:15px;}
    .social-section img{width:40px;height:40px;}
    .overlay-fond{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:none;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto;z-index:999;}
    .modal-container{background:#111;border-radius:10px;padding:20px;max-width:700px;width:100%;box-shadow:0 4px 20px rgba(0,0,0,0.8);position:relative;}
    .modal-container button{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
    .thumbnail{width:auto;max-width:100%;height:auto;max-height:70vh;object-fit:contain;border-radius:6px;margin-bottom:12px;}
    .modal-title{font-size:24px;font-weight:700;margin-bottom:8px;}
    .modal-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .season-list{position:absolute;top:60px;right:20px;background:#111;border-radius:6px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.7);display:none;z-index:1001;}
    .season-list button{width:100%;padding:10px;text-align:left;background:#222;color:#fff;border:none;border-bottom:1px solid #333;cursor:pointer;}
    .modal-info{background:#111;border-radius:6px;padding:12px;font-size:14px;color:#ddd;margin-bottom:12px;display:none;}
    .modal-episodes{display:grid;grid-template-columns:1fr;gap:10px;}
    .episode-item{background:rgba(0,0,0,0.6);padding:12px;border-radius:8px;cursor:pointer;transition:transform .2s;}
    .episode-item:hover{transform:scale(1.02);}
    .episode-item.active { background: rgba(200,200,200,0.3); }
    .episode-item.visited { background: rgba(50,50,50,0.4); color: #aaa; font-weight: normal; }
    .ad-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:1000;}
    .ad-container{background:#111;padding:20px;border-radius:10px;text-align:center;}
    .ad-container button{background:#444;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;}
    #splash { position: fixed; inset:0; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; animation: splashPop 1.7s forwards; }
    .splash-logo { font-size:3rem; font-weight:bold;background:linear-gradient(90deg,#fff,#black);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter: blur(0.5px); margin:0; animation:logoPop 1.7s ease-out forwards; }
    .splash-version { margin-top:0.5rem; color:#aaa; font-size:1rem; animation:logoPop 1.7s ease-out forwards; }
    @keyframes splashPop { 0%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
    @keyframes logoPop { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.2)} 80%{transform:scale(1.1)} 100%{opacity:0;transform:scale(1.1)} }
    .media-container { width:100%; height:auto; overflow:visible; padding:6px 0; background:transparent; display:flex; justify-content:center; align-items:center; }
    .media-container img, .media-container video { width:auto; height:auto; max-width:100%; max-height:80vh; object-fit:contain; display:block; margin:0 auto; border-radius:8px; }
    .post-card .media-container { padding:6px 0; }
    .post-card .media-container img { width:auto; height:auto; max-width:100%; max-height:360px; object-fit:contain; display:block; margin:0 auto; }
    .post-card .media-container video { width:auto; height:auto; max-width:100%; max-height:480px; object-fit:contain; display:block; border-radius:8px; }
    .explorer-video { width:auto; max-width:100%; height:auto; max-height:480px; object-fit:contain; border-radius:8px; display:block; margin:0 auto; }
    .notif-request { position:fixed;left:50%;transform:translateX(-50%);bottom:76px;background:#111;padding:12px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.7);z-index:10001;display:none;align-items:center;gap:8px; }
    .notif-request button{background:#222;border:1px solid #333;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer;}
    .notif-request small{display:block;color:#bbb;font-size:13px;margin-top:6px;text-align:center;}
    * { -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; user-select: none !important; }
    input, textarea, select, .search-box { -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; user-select: text !important; }
    body, html { -webkit-touch-callout: none; }
    ::-webkit-scrollbar { display: none; }
    html { scrollbar-width: none; -ms-overflow-style: none; }
  </style>
</head>
<body>
  <div id="splash"><h1 class="splash-logo">TF-Stream</h1><p class="splash-version">D'H7 | Tergene</p></div>
  <div id="fondOverlay" class="overlay-fond" aria-hidden="true"></div>

  <div class="header" id="mainHeader">
    <div class="logo" id="appLogo">TF-Stream</div>
    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterCategory('Tout',event)">Tout</button>
      <button class="filter-btn" onclick="filterCategory('Film',event)">Film</button>
      <button class="filter-btn" onclick="filterCategory('Série',event)">Série</button>
      <button class="filter-btn" onclick="filterCategory('Anime',event)">Anime</button>
    </div>
    <div class="search-container">
      <input id="searchBox" class="search-box" type="text" placeholder="Rechèch..." autocomplete="off">
    </div>
  </div>

  <div class="video-list" id="videoList"></div>
  <div id="explorerView"></div>

  <div class="nav-bar">
    <button class="nav-btn active" onclick="navigateTo('Accueil',event)">Accueil</button>
    <button class="nav-btn" onclick="navigateTo('Explorer',event)">Explorer</button>
  </div>

  <div id="adOverlay" class="ad-overlay">
    <div class="ad-container">
      <p>Publicité</p>
      <button id="adLinkBtn">En savoir plus</button>
      <button onclick="closeAd()">Fermer</button>
    </div>
  </div>

  <!-- Boîte d'activation (UI inchangée visuellement) -->
  <div id="notifRequest" class="notif-request" role="dialog" aria-hidden="true">
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="font-weight:700">Activer notifications</div>
      <button onclick="requestNotificationPermission('android')">Android</button>
      <button onclick="requestNotificationPermission('pc')">PC</button>
      <button onclick="requestNotificationPermission('iphone')">iPhone</button>
      <button onclick="hideNotifRequest()">Plus tard</button>
    </div>
    <small id="notifRequestHint">Recevez des nouveautés (Film, Série, Anime). Pas de notifications pour les postes.</small>
  </div>

<script>
/* ======================
   RÉGLAGES À REMPLIR
   - Remplace cette clé par ta clé publique VAPID (base64 url-safe)
   ====================== */
const VAPID_PUBLIC_KEY = 'REPLACE_WITH_YOUR_VAPID_PUBLIC_KEY_BASE64_URLSAFE';

/* ======================
   CONSTANTES & HELPERS
   ====================== */
console.warn = ()=>{};
console.error = ()=>{};
const IMAGE_TIMEOUT = 7000;
const NO_THUMB_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="288" viewBox="0 0 512 288"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ddd" font-family="Arial, Helvetica, sans-serif" font-size="32">No Thumb</text></svg>');

function urlBase64ToUint8Array(base64String) {
  // standard helper pour VAPID key
  const padding = '='.repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding).replace(/\-/g, '+').replace(/_/g, '/');
  const rawData = atob(base64);
  const outputArray = new Uint8Array(rawData.length);
  for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
  return outputArray;
}

/* ======================
   DÉTECTION (TWA, iOS, in-app)
   ====================== */
function isInAppBrowser(){
  const ua = navigator.userAgent || '';
  // On veut détecter navigateurs in-app et TWA
  return /FBAN|FBAV|Instagram|wv|WebView|FB_IAB|Twitter|Pinterest|Line/i.test(ua);
}
function isiOS(){
  return /iP(hone|od|ad)/i.test(navigator.userAgent);
}
function iOSVersion(){
  const m = navigator.userAgent.match(/OS (\d+)_?(\d+)?/);
  if(!m) return null;
  return parseFloat(`${m[1]}.${m[2] || 0}`);
}
function isAndroid() { return /Android/i.test(navigator.userAgent); }
function isTWA(){
  // TWA user agent usually contains "Chrome" and "Mobile" but also "wv" in some builds;
  // c'est une heuristique : si c'est Android et display-mode standalone -> TWA possible.
  try{
    return isAndroid() && (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true || /wv|Version\/\d+\.\d+ Chrome\/\d+/.test(navigator.userAgent));
  }catch(e){ return false; }
}

/* ======================
   SERVICE WORKER + SUBSCRIPTION
   ====================== */
async function registerServiceWorker(){
  if(!('serviceWorker' in navigator)) return null;
  try{
    const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
    // attendre ready
    await navigator.serviceWorker.ready;
    return reg;
  }catch(e){
    console.error('sw register failed', e);
    return null;
  }
}

async function getExistingSubscription(reg){
  try{
    if(!reg || !reg.pushManager) return null;
    return await reg.pushManager.getSubscription();
  }catch(e){
    return null;
  }
}

async function postSubscriptionToServer(subscription){
  // adapte URL serveur si besoin
  try{
    await fetch('/api/subscribe', {
      method: 'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify({ subscription })
    });
    // côté serveur : sauvegarder la subscription et utiliser web-push + VAPID pour envoyer
  }catch(e){
    console.error('post subscription error', e);
  }
}

async function subscribeForPush(opts = { retries: 3 }){
  if(!('serviceWorker' in navigator) || !('PushManager' in window) || !VAPID_PUBLIC_KEY) {
    throw new Error('Push non supporté ou VAPID non configurée');
  }
  const reg = await navigator.serviceWorker.ready;
  if(!reg) throw new Error('Service worker non ready');

  // si déjà abonné, on renvoie
  const existing = await getExistingSubscription(reg);
  if(existing) {
    await postSubscriptionToServer(existing);
    return existing;
  }

  // tenter l'abonnement (retry)
  let attempt = 0;
  while(attempt < opts.retries){
    attempt++;
    try{
      const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
      });
      await postSubscriptionToServer(sub);
      localStorage.setItem('tf_push_subscribed', '1');
      // masquer le banner si présent
      hideNotifRequest();
      return sub;
    }catch(e){
      console.error('subscribe attempt', attempt, e);
      // si permission denied, on arrête immédiatement
      if(Notification.permission === 'denied') throw e;
      // backoff bref
      await new Promise(res => setTimeout(res, 500 * attempt));
    }
  }
  throw new Error('Impossible de souscrire au push après plusieurs essais');
}

/* ======================
   LOGIC: demande de permission & flow robuste
   ====================== */
function showNotifPromptIfNeeded(){
  try{
    const asked = localStorage.getItem('tf_notif_asked_v2');
    if((!('Notification' in window)) || (Notification && Notification.permission === 'granted')) return;
    if(asked) return;
    // adapt hint pour iOS
    if(isiOS()){
      const v = iOSVersion();
      if(v && v < 16.4){
        document.getElementById('notifRequestHint').textContent =
          'iOS ancienne version — les notifications web peuvent ne pas être supportées. Mets à jour iOS / ouvre dans Safari / ajoute à l’écran d’accueil.';
      } else {
        document.getElementById('notifRequestHint').textContent =
          'Sur iPhone: ouvre dans Safari (et assure-toi iOS >= 16.4).';
      }
    }
    document.getElementById('notifRequest').style.display = 'flex';
    document.getElementById('notifRequest').setAttribute('aria-hidden','false');
  }catch(e){}
}
function hideNotifRequest(){ document.getElementById('notifRequest').style.display = 'none'; document.getElementById('notifRequest').setAttribute('aria-hidden','true'); localStorage.setItem('tf_notif_asked_v2','1'); }

/**
 * requestNotificationPermission(platform)
 * platform: 'android' | 'pc' | 'iphone'
 *
 * - Appelle Notification.requestPermission() (toujours après une action utilisateur)
 * - Si granted -> tente subscribeForPush()
 * - Pour TWA: on vérifie et on affiche instructions natives si OS bloque
 */
async function requestNotificationPermission(platform){
  try{
    localStorage.setItem('tf_notif_asked_v2','1');
    document.getElementById('notifRequest').style.display = 'none';

    if(!('Notification' in window)){
      alert('Notifications non supportées par ce navigateur.');
      return;
    }

    if(isInAppBrowser()){
      // navigateur intégré: souvent impossible. on prévient
      alert('Les navigateurs intégrés (Facebook/Instagram) bloquent souvent les notifications. Ouvre le site dans Chrome/Edge/Safari.');
      return;
    }

    // Si TWA : indique à l'utilisateur d'autoriser l'APP (native) si besoin
    if(isTWA()){
      // la permission Android (POST_NOTIFICATIONS) doit être demandée par l'APK natif.
      // On lance la requête web quand même; si ça ne suffit on montre instructions.
      // Important: si ton wrapper n'a pas demandé POST_NOTIFICATIONS, ajoutes instructions (voir message en bas).
      console.log('Attention: App dans TWA détectée. Vérifie permission OS POST_NOTIFICATIONS dans l’APK.');
    }

    // Demande permission web (doit être déclenchée par un click)
    const result = await Notification.requestPermission();
    if(result === 'granted'){
      // attendre que SW soit prêt
      try{
        await registerServiceWorker();
      }catch(e){}
      // lancer subscribe (essayé plusieurs fois si besoin)
      try{
        await subscribeForPush({ retries: 4 });
        alert('Notifications activées — merci !');
      }catch(e){
        // si c'est TWA et subscription fail, donne instructions
        console.error('subscribe failed', e);
        if(isTWA()){
          alert('La permission web est accordée mais l’abonnement push a échoué dans TWA. Vérifie que l’application native a demandé la permission POST_NOTIFICATIONS (Android 13+).');
        } else {
          alert('Erreur lors de l’abonnement aux push (voir console). Réessaie ou vérifie le serveur / VAPID.');
        }
      }
    } else if(result === 'denied'){
      alert('Notifications refusées — tu peux activer depuis les réglages du navigateur.');
    } else {
      // result === 'default'
      showNotifPromptIfNeeded();
    }
  }catch(e){
    console.error('notif request error', e);
    alert('Problème lors de la requête de permission (voir console).');
  }
}

/* ======================
   Auto-check: si permission déjà granted -> tente subscribe automatiquement
   (utile au chargement après que l'utilisateur ait accepté via OS)
   ====================== */
async function autoSubscribeIfPossible(){
  if(!('Notification' in window)) return;
  if(Notification.permission !== 'granted') return;
  if(!('serviceWorker' in navigator)) return;
  try{
    await registerServiceWorker();
    const reg = await navigator.serviceWorker.ready;
    const existing = await getExistingSubscription(reg);
    if(!existing){
      await subscribeForPush({ retries: 4 });
      console.log('Auto-subscribe ok');
    } else {
      console.log('déjà abonné');
      // assurer qu'on a envoyé la subscription au serveur
      await postSubscriptionToServer(existing);
      hideNotifRequest();
    }
  }catch(e){
    console.error('autoSubscribeIfPossible error', e);
  }
}

/* ======================
   Service worker message handler (déjà présent dans ton code)
   ====================== */
function handleServiceWorkerMessage(event){
  const msg = event && event.data ? event.data : null;
  if(!msg || !msg.type) return;
  if(msg.type === 'NOTIFICATION_CLICK'){
    const slug = msg.payload && msg.payload.slug ? msg.payload.slug : undefined;
    if(!slug){ navigatePath('/Accueil'); return; }
    const tryOpen = (attemptsLeft=1)=>{
      const info = window.slugMap && (window.slugMap[slug] || window.slugMap[slug.toLowerCase()]);
      if(info && info.item){
        try { showPostModal(info.item, info.index, { push: false }); } catch(e){ navigatePath('/Accueil'); }
        return true;
      }
      if(attemptsLeft>0){
        refreshData().then(()=>{ setTimeout(()=>tryOpen(attemptsLeft-1), 250); }).catch(()=>{ setTimeout(()=>tryOpen(attemptsLeft-1), 250); });
        return false;
      }
      navigatePath('/Accueil');
      return false;
    };
    tryOpen(1);
  } else if(msg.type === 'CACHES_LIST'){
    // noop
  }
}

navigator.serviceWorker && navigator.serviceWorker.addEventListener && navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);

/* ======================
   Au chargement : enregistre SW, pré-charges ton contenu puis affiche prompt si nécessaire
   ====================== */
window.addEventListener('load', async ()=>{
  // register SW asap (permet subscribe ensuite)
  if('serviceWorker' in navigator){
    try{
      await registerServiceWorker();
      // si la permission est déjà granted (ex: l'utilisateur a accepté via OS), on tente auto subscribe
      setTimeout(autoSubscribeIfPossible, 500);
    }catch(e){ console.error('sw register error', e); }
  }
  // afficher prompt si utile
  setTimeout(showNotifPromptIfNeeded, 900);
});

/* ======================
   Fonctions utilitaires existantes du site (pas de changements visuels)
   Ici j'inclus les fonctions minimes nécessaires : escapeHtml, displayVideos, ... 
   (pour ne pas casser ton app, j'ai gardé l'essentiel)
   ====================== */
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

/* === Ici : garde tout le reste de ton code (affichage vidéo / explorer / modal...)
   Pour la longueur je n'ai pas ré-écrit tout l'affichage (tu avais déjà le reste),
   mais la logique notifications ci-dessus est complète et s'intègre avec ton SW.
   Si tu veux, je peux réinjecter TOUT ton code d'affichage (mais tu l'avais déjà) === */

/* Pour debug rapide depuis console */
window.__tf_debug = {
  isTWA: isTWA(),
  userAgent: navigator.userAgent,
  notifPermission: Notification && Notification.permission,
  hasServiceWorker: 'serviceWorker' in navigator,
  canPush: ('PushManager' in window)
};

</script>

<!-- Si tu as un script externe, je le laisse tel quel (mais vérifie si tu veux le garder) -->
<script type='text/javascript' src='//pantherinvincible.com/64/68/83/6468839024f881b57715852274ce968b.js'></script>
</body>
    </html>
