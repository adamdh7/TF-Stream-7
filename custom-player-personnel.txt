<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Custom player — overlays landscape (dim but video plays)</title>
<style>
  :root{
    --bg:#000;
    --muted:#9aa0a6;
    --accent:#fff;
    --seek-height:8px;
    --box-bg: rgba(255,255,255,0.02);
    --box-border: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--accent);font-family:Inter,system-ui,Arial,sans-serif}
  .wrap, .video-card, .controls-wrap, .inside-mini-controls, .menu-overlay, .lang-overlay { user-select:none; -webkit-user-select:none; -ms-user-select:none; -moz-user-select:none; }

  .wrap{max-width:1100px;margin:28px auto;padding:12px;width:95%}

  .video-card{position:relative;border-radius:12px;overflow:hidden;background:#000;aspect-ratio:16/9;max-height:68vh;min-height:180px;touch-action:none}
  video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;z-index:1;background:#000;transition:filter .08s linear}
  video.contain{ object-fit:contain; background:#000; }

  .controls-wrap{position:absolute;left:12px;right:12px;bottom:12px;pointer-events:none;z-index:12;transition:opacity .18s ease}
  .time-row{display:flex;align-items:center;gap:12px;padding:8px 12px;color:var(--muted);font-size:14px;justify-content:center}
  .time{width:82px;text-align:center;font-variant-numeric:tabular-nums}
  .progress{flex:1;max-width:820px;display:flex;align-items:center}
  .seek{position:relative;height:var(--seek-height);width:100%;border-radius:999px;cursor:pointer;background:repeating-linear-gradient(90deg, rgba(255,255,255,0.06) 0 2px, rgba(255,255,255,0) 2px 12px);}
  .fill{position:absolute;left:0;top:0;height:100%;width:0%;border-radius:999px;background:linear-gradient(90deg, rgba(255,255,255,0.95), rgba(255,255,255,0.55));}
  .thumb{position:absolute;top:50%;transform:translate(-50%,-50%);width:18px;height:18px;border-radius:50%;background:#0b0b0b;border:2px solid var(--accent);box-shadow:none;pointer-events:auto;touch-action:none}

  .controls-hidden{opacity:0;pointer-events:none}
  .controls-visible{opacity:1;pointer-events:auto}

  .inside-mini-controls{
    position:absolute;
    left:12px;
    right:12px;
    bottom:92px;
    z-index:13;
    display:flex;
    justify-content:center;
    gap:14px;
    pointer-events:auto;
    transition:bottom .18s ease, opacity .18s ease;
  }
  .inside-hidden{opacity:0;pointer-events:none}
  .inside-visible{opacity:1;pointer-events:auto}
  .video-card.landscape-mode .inside-mini-controls{ bottom:160px; }

  .inside-item{
    min-width:86px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:8px;
    border-radius:10px;
    background:var(--box-bg);
    border:1px solid var(--box-border);
  }
  .inside-item .mini-btn{
    width:100%;
    height:44px;
    border-radius:8px;
    border:none;
    background:transparent;
    color:var(--accent);
    font-weight:700;
    font-size:15px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    -webkit-tap-highlight-color: transparent;
  }
  .inside-item .mini-btn:active{transform:translateY(1px)}
  @media (orientation:landscape) { .inside-item{min-width:110px;padding:10px} }

  .landscape-btn{margin-left:8px;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer}
  .landscape-btn:hover{color:var(--accent)}

  /* hide menu-dots in portrait; show in landscape/fullscreen */
  .menu-dots{margin-left:6px;border:none;background:transparent;color:var(--muted);font-size:18px;cursor:pointer;display:none;padding:6px;border-radius:8px}
  .video-card.landscape-mode .menu-dots{ display:inline-block; }
  @media (orientation:landscape) { .menu-dots { display:inline-block; } }
  .menu-dots:hover{color:var(--accent);background:rgba(255,255,255,0.02)}

  .swipe-indicator{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    min-width:140px;
    padding:10px 14px;
    border-radius:10px;
    background:rgba(0,0,0,0.75);
    color:var(--accent);
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    z-index:20;
    pointer-events:none;
    opacity:0;
    transition:opacity .12s ease;
    font-weight:700;
    font-size:15px;
  }
  .swipe-indicator.show{opacity:1}
  .swipe-icon{width:22px;height:22px;flex:0 0 22px}
  .swipe-value{min-width:48px;text-align:right;font-variant-numeric:tabular-nums}

  .error{position:absolute;left:12px;right:12px;top:50%;transform:translateY(-50%);background:rgba(0,0,0,0.6);padding:16px;border-radius:10px;color:#ff9b9b;display:none;text-align:center;z-index:20}
  .error a{color:#fff;text-decoration:underline}

  /* Overlays: très haut pour couvrir tout en paysage.
     Par défaut fixed on body; when opened in landscape we inject inside .video-card and make absolute inset:0
  */
  .menu-overlay, .lang-overlay {
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:99999;
    pointer-events:auto;
    opacity:0;
    visibility:hidden;
    transition:opacity .14s ease, visibility .14s;
  }
  .menu-overlay.show, .lang-overlay.show { opacity:1; visibility:visible; }
  .menu-backdrop, .lang-backdrop { position:absolute; inset:0; z-index:99990; background:rgba(0,0,0,0.5); } /* 50% cover */
  .menu-sheet, .lang-sheet {
    position:relative;
    z-index:99999;
    min-width:280px;
    max-width:92%;
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border:1px solid rgba(255,255,255,0.04);
    padding:16px;
    color:var(--accent);
    box-shadow: 0 10px 30px rgba(0,0,0,0.6);
  }
  .menu-header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .back-btn{background:transparent;border:none;color:var(--muted);font-size:16px;display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px;border-radius:8px}
  .back-btn:hover{color:var(--accent);background:rgba(255,255,255,0.02)}
  .close-btn{margin-left:auto;background:transparent;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:6px;border-radius:8px}
  .close-btn:hover{color:var(--accent);background:rgba(255,255,255,0.02)}

  .menu-list{display:flex;flex-direction:column;gap:8px}
  .menu-item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);cursor:pointer;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between}
  .menu-item:hover{background:rgba(255,255,255,0.03)}
  .menu-item strong{font-weight:700}

  .lang-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .lang-item{padding:12px;border-radius:10px;background:rgba(255,255,255,0.01);cursor:pointer;border:1px solid rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:space-between}
  .lang-item:hover{background:rgba(255,255,255,0.03)}
  .bold{font-weight:800}
</style>
</head>
<body>
  <div class="wrap">
    <div class="video-card" id="card">
      <video id="video" preload="auto" playsinline crossorigin="anonymous">
        <source src="https://pub-6801bec6f6414c08995c6708f70f99c2.r2.dev/1765156879946-Solo_Leveling_2_-_EP_13_VF.mp4" type="video/mp4">
        Votre navigateur ne supporte pas la vidéo HTML5.
      </video>

      <div class="inside-mini-controls inside-visible" id="insideMini">
        <div class="inside-item"><button class="mini-btn" id="insideBack">-10</button></div>
        <div class="inside-item"><button class="mini-btn" id="insidePlay">❚❚</button></div>
        <div class="inside-item"><button class="mini-btn" id="insideForward">+10</button></div>
      </div>

      <div class="controls-wrap controls-visible" id="controlsWrap">
        <div class="time-row" id="timeRow">
          <div class="time" id="current">0:00</div>
          <div class="progress">
            <div class="seek" id="seekBar" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
              <div class="fill" id="fill"></div>
              <div class="thumb" id="thumb" aria-hidden="true"></div>
            </div>
          </div>
          <div class="time" id="duration">0:00</div>
          <button class="landscape-btn" id="landscapeBtn" title="Basculer paysage">⛶</button>
          <button class="menu-dots" id="menuBtn" title="Menu">⋯</button>
        </div>
      </div>

      <div class="swipe-indicator" id="swipeIndicator" aria-hidden="true">
        <div class="swipe-icon" id="swipeIcon"></div>
        <div class="swipe-value" id="swipeValue">0%</div>
      </div>

      <div class="error" id="errorBox">Impossible de lire la vidéo. <span id="errTxt"></span></div>
    </div>
  </div>

  <!-- MENU OVERLAY (backdrop covers entire viewport at 50% and video keeps playing) -->
  <div class="menu-overlay" id="menuOverlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="menu-backdrop" id="menuBackdrop"></div>
    <div class="menu-sheet" role="document" aria-label="Menu player">
      <div class="menu-header">
        <button class="back-btn" id="menuBackBtn" title="Retour" aria-label="Retour" style="display:none">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Retour
        </button>
        <strong style="font-weight:700">Options</strong>
        <button class="close-btn" id="menuCloseBtn" title="Fermer" aria-label="Fermer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="menu-list" id="menuList">
        <div class="menu-item" id="menuLang" role="button" tabindex="0">
          <span>Langue</span>
          <span aria-hidden="true">›</span>
        </div>
        <div class="menu-item" id="menuPip" role="button" tabindex="0">
          <span>Mode PIP</span>
          <span id="pipStatus" style="opacity:.8;font-size:13px">Activer</span>
        </div>
      </div>
    </div>
  </div>

  <!-- LANGUAGE OVERLAY (covers menu when opened; video still plays) -->
  <div class="lang-overlay" id="langOverlay" aria-hidden="true" role="dialog" aria-modal="true">
    <div class="lang-backdrop" id="langBackdrop"></div>
    <div class="lang-sheet" role="document" aria-label="Langue settings">
      <div class="menu-header">
        <button class="back-btn" id="langBackBtn" title="Retour" aria-label="Retour">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M15 18l-6-6 6-6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Retour
        </button>
        <strong style="font-weight:700">Langue</strong>
        <button class="close-btn" id="langCloseBtn" title="Fermer" aria-label="Fermer">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="color:var(--muted)"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <div class="lang-list">
        <div class="lang-item"><strong class="bold">Audio</strong><span style="opacity:.8">Français</span></div>
        <div class="lang-item"><strong class="bold">Sous-titre</strong><span style="opacity:.8">Français</span></div>
      </div>
    </div>
  </div>

<script>
(function(){
  const card = document.getElementById('card');
  const video = document.getElementById('video');

  const insidePlay = document.getElementById('insidePlay');
  const insideForward = document.getElementById('insideForward');
  const insideBack = document.getElementById('insideBack');

  const seekBar = document.getElementById('seekBar');
  const fill = document.getElementById('fill');
  const thumb = document.getElementById('thumb');
  const currentEl = document.getElementById('current');
  const durationEl = document.getElementById('duration');
  const landscapeBtn = document.getElementById('landscapeBtn');
  const menuBtn = document.getElementById('menuBtn');

  const controlsWrap = document.getElementById('controlsWrap');
  const insideMini = document.getElementById('insideMini');

  const swipeIndicator = document.getElementById('swipeIndicator');
  const swipeIcon = document.getElementById('swipeIcon');
  const swipeValue = document.getElementById('swipeValue');

  const menuOverlay = document.getElementById('menuOverlay');
  const menuBackdrop = document.getElementById('menuBackdrop');
  const menuCloseBtn = document.getElementById('menuCloseBtn');
  const menuBackBtn = document.getElementById('menuBackBtn');
  const menuLang = document.getElementById('menuLang');
  const menuPip = document.getElementById('menuPip');
  const pipStatus = document.getElementById('pipStatus');

  const langOverlay = document.getElementById('langOverlay');
  const langBackdrop = document.getElementById('langBackdrop');
  const langCloseBtn = document.getElementById('langCloseBtn');
  const langBackBtn = document.getElementById('langBackBtn');

  const svgBrightness = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M12 4V2M12 22v-2M4.93 4.93L3.51 3.51M20.49 20.49l-1.42-1.42M4 12H2M22 12h-2M4.93 19.07l-1.42 1.42M20.49 3.51l-1.42 1.42M12 8a4 4 0 100 8 4 4 0 000-8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
  const svgVolume = `<svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M11 5L6 9H2v6h4l5 4V5z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M19 9a5 5 0 010 6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`;

  const cornerRatio = 0.20;

  function formatTime(sec){
    sec = Math.floor(sec) || 0;
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    if(h>0) return h + ":" + String(m).padStart(2,'0') + ":" + String(s).padStart(2,'0');
    return m + ":" + String(s).padStart(2,'0');
  }

  function isFullscreenCard(){ return document.fullscreenElement === card || document.webkitFullscreenElement === card; }
  function isDeviceLandscape(){ return window.innerWidth > window.innerHeight; }
  function allowOverlayNow(){ return isFullscreenCard() || isDeviceLandscape(); }

  async function tryAutoplay(){
    try { await video.play(); } catch(e){ try { video.muted = true; await video.play(); } catch(_){} }
    updatePlayIcon();
  }
  function updatePlayIcon(){ insidePlay.textContent = video.paused ? '▶︎' : '❚❚'; }
  async function togglePlay(){ try{ if(video.paused){ try{ video.muted = false; } catch(e){} await video.play(); } else video.pause(); } catch(e){ console.warn(e);} updatePlayIcon(); }
  insidePlay.addEventListener('click', (e)=>{ e.stopPropagation(); togglePlay(); });

  insideForward.addEventListener('click', (e)=>{ e.stopPropagation(); video.currentTime = Math.min(video.duration || 0, video.currentTime + 10); });
  insideBack.addEventListener('click', (e)=>{ e.stopPropagation(); video.currentTime = Math.max(0, video.currentTime - 10); });

  // SCRUB immediate seeking (kept)
  let scrubbing = false;
  let wasPlayingBeforeScrub = false;
  function timeFromClientX(clientX){
    const r = seekBar.getBoundingClientRect();
    let p = (clientX - r.left) / r.width;
    p = Math.max(0, Math.min(1, p));
    return (video.duration || 0) * p;
  }
  function startScrub(clientX){
    wasPlayingBeforeScrub = !video.paused;
    try { video.pause(); } catch(e){}
    scrubbing = true;
    const t = timeFromClientX(clientX);
    video.currentTime = t;
    currentEl.textContent = formatTime(t);
    const pct = (t / (video.duration || 1)) * 100;
    fill.style.width = pct + '%';
    thumb.style.left = pct + '%';
  }
  function moveScrub(clientX){
    if(!scrubbing) return;
    const t = timeFromClientX(clientX);
    video.currentTime = t;
    currentEl.textContent = formatTime(t);
    const pct = (t / (video.duration || 1)) * 100;
    fill.style.width = pct + '%';
    thumb.style.left = pct + '%';
  }
  function endScrub(){
    if(!scrubbing) return;
    scrubbing = false;
    if(wasPlayingBeforeScrub){
      try { video.play().catch(()=>{}); } catch(e){}
    }
  }

  seekBar.addEventListener('mousedown', (e)=>{ e.preventDefault(); e.stopPropagation(); startScrub(e.clientX); });
  window.addEventListener('mousemove', (e)=>{ moveScrub(e.clientX); });
  window.addEventListener('mouseup', (e)=>{ endScrub(); });

  seekBar.addEventListener('touchstart', (e)=>{ e.preventDefault(); e.stopPropagation(); startScrub(e.touches[0].clientX); }, {passive:false});
  window.addEventListener('touchmove', (e)=>{ if(e.touches && e.touches[0]) moveScrub(e.touches[0].clientX); }, {passive:false});
  window.addEventListener('touchend', (e)=>{ endScrub(); });

  thumb.addEventListener('pointerdown', (e)=>{ e.preventDefault(); e.stopPropagation(); startScrub(e.clientX); });
  window.addEventListener('pointermove', (e)=>{ if(e.pointerType) moveScrub(e.clientX); });
  window.addEventListener('pointerup', (e)=>{ endScrub(); });

  video.addEventListener('timeupdate', ()=> {
    currentEl.textContent = formatTime(video.currentTime);
    const pct = (video.currentTime / (video.duration || 1)) * 100;
    fill.style.width = pct + '%';
    thumb.style.left = pct + '%';
    seekBar.setAttribute('aria-valuenow', Math.floor(video.currentTime || 0));
  });
  video.addEventListener('loadedmetadata', ()=> {
    durationEl.textContent = formatTime(video.duration || 0);
    seekBar.setAttribute('aria-valuemax', Math.floor(video.duration || 0));
  });
  video.addEventListener('play', updatePlayIcon);
  video.addEventListener('pause', updatePlayIcon);

  function showAll(){ controlsWrap.classList.remove('controls-hidden'); controlsWrap.classList.add('controls-visible'); insideMini.classList.remove('inside-hidden'); insideMini.classList.add('inside-visible'); }
  function hideAll(){ controlsWrap.classList.remove('controls-visible'); controlsWrap.classList.add('controls-hidden'); insideMini.classList.remove('inside-visible'); insideMini.classList.add('inside-hidden'); }
  function toggleAll(){ const isVisible = controlsWrap.classList.contains('controls-visible') && insideMini.classList.contains('inside-visible'); if(isVisible) hideAll(); else showAll(); }

  function isOverControls(target){
    return !!(target && (target.closest && (target.closest('.controls-wrap') || target.closest('.inside-mini-controls') || target.closest('.inside-item') || target.closest('.seek'))));
  }

  card.addEventListener('click', (e)=>{
    if(isOverControls(e.target)) return;
    toggleAll();
  });

  [insidePlay, insideForward, insideBack, seekBar, landscapeBtn, menuBtn].forEach(el=>{
    if(!el) return;
    el.addEventListener('click', e=>e.stopPropagation());
    el.addEventListener('pointerdown', e=>e.stopPropagation());
    el.addEventListener('touchstart', e=>e.stopPropagation(), {passive:false});
  });

  // -------------------------
  // landscape / fullscreen toggles (FROM CODE 2)
  // -------------------------
  async function enterLandscapeMode(){
    try{
      const el = card;
      if (el.requestFullscreen) await el.requestFullscreen();
      else if (el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
      if (screen.orientation && screen.orientation.lock) {
        try { await screen.orientation.lock('landscape'); } catch(_) {}
      }
    }catch(err){ console.warn('enterLandscape failed', err); }
    card.classList.add('landscape-mode');
    video.classList.add('contain');
    showAll();
  }
  async function exitLandscapeMode(){
    try{
      if (screen.orientation && screen.orientation.unlock) {
        try { screen.orientation.unlock(); } catch(_) {}
      }
      if (document.exitFullscreen) await document.exitFullscreen();
      else if (document.webkitExitFullscreen) await document.webkitExitFullscreen();
    }catch(err){ console.warn('exitLandscape failed', err); }
    card.classList.remove('landscape-mode');
    video.classList.remove('contain');
    showAll();
  }
  landscapeBtn.addEventListener('click', async (e)=>{ e.stopPropagation(); if(!isFullscreenCard()){ await enterLandscapeMode(); } else { await exitLandscapeMode(); } });

  // update fullscreenchange to align with orientation-lock behaviour
  document.addEventListener('fullscreenchange', ()=> {
    if(document.fullscreenElement === card) {
      card.classList.add('landscape-mode');
      video.classList.add('contain');
      showAll();
    } else {
      card.classList.remove('landscape-mode');
      video.classList.remove('contain');
      showAll();
      // move overlays back to body so portrait won't show them covering page
      if(menuOverlay.parentNode === card) document.body.appendChild(menuOverlay);
      if(langOverlay.parentNode === card) document.body.appendChild(langOverlay);
    }
  });

  // gestures (kept)...
  let gesture = null;
  let indicatorTimeout = null;
  function showSwipeIndicator(kind, percent){
    swipeIcon.innerHTML = (kind === 'brightness') ? svgBrightness : svgVolume;
    swipeValue.textContent = percent + '%';
    swipeIndicator.classList.add('show');
    if(indicatorTimeout) clearTimeout(indicatorTimeout);
    indicatorTimeout = setTimeout(()=>{ swipeIndicator.classList.remove('show'); }, 800);
  }
  function clamp(v,a=0,b=1){ return Math.max(a, Math.min(b, v)); }
  function startLandscapeGesture(clientX, clientY){
    if(!card.classList.contains('landscape-mode')) return;
    const rect = card.getBoundingClientRect();
    const relX = clientX - rect.left;
    const leftLimit = rect.width * cornerRatio;
    const rightLimit = rect.width * (1 - cornerRatio);
    if(relX <= leftLimit){
      const styleFilter = getComputedStyle(video).filter || '';
      const match = styleFilter.match(/brightness\(([^)]+)\)/);
      const initial = match ? parseFloat(match[1]) : 1;
      gesture = { type:'brightness', startY:clientY, initialValue: isNaN(initial) ? 1 : initial };
      showSwipeIndicator('brightness', Math.round(gesture.initialValue * 100));
    } else if(relX >= rightLimit){
      gesture = { type:'volume', startY:clientY, initialValue: video.volume };
      showSwipeIndicator('volume', Math.round(gesture.initialValue * 100));
    } else { gesture = null; }
  }
  function moveLandscapeGesture(clientY){
    if(!gesture) return;
    const rect = card.getBoundingClientRect();
    const delta = (gesture.startY - clientY);
    const pct = delta / rect.height;
    let newVal = gesture.initialValue + pct;
    newVal = clamp(newVal, 0, 1);
    if(gesture.type === 'brightness'){
      const applied = Math.max(0.05, newVal);
      video.style.filter = `brightness(${applied})`;
      showSwipeIndicator('brightness', Math.round(applied * 100));
    } else {
      video.volume = newVal;
      showSwipeIndicator('volume', Math.round(newVal * 100));
    }
  }
  function endLandscapeGesture(){
    if(!gesture) return;
    gesture = null;
    if(indicatorTimeout) clearTimeout(indicatorTimeout);
    indicatorTimeout = setTimeout(()=>{ swipeIndicator.classList.remove('show'); }, 600);
  }
  // attach simplified touch/mouse handlers (kept as before)
  card.addEventListener('touchstart', (e)=>{ if(!card.classList.contains('landscape-mode')) return; const t = e.touches[0]; startLandscapeGesture(t.clientX, t.clientY); }, {passive:false});
  card.addEventListener('touchmove', (e)=>{ if(!card.classList.contains('landscape-mode')) return; const t = e.touches[0]; moveLandscapeGesture(t.clientY); }, {passive:false});
  card.addEventListener('touchend', ()=>{ if(!card.classList.contains('landscape-mode')) return; endLandscapeGesture(); });

  // error handling (kept)
  const sourceUrl = video.querySelector('source')?.src || '';
  video.addEventListener('error', async (e)=>{
    try {
      const r = await fetch(sourceUrl, { method: 'HEAD', mode: 'cors' });
      if(!r.ok) showError('Le serveur répond ' + r.status + '.');
    } catch(fetchErr){
      console.error('HEAD failed', fetchErr);
      showError('Probable CORS (Access-Control-Allow-Origin absent). Ouvri console pour détails.');
    }
  });
  function showError(msg){ const errTxt = document.getElementById('errTxt'); if(errTxt) errTxt.textContent = msg; const eb = document.getElementById('errorBox'); if(eb) eb.style.display='block'; }

  // ---------- MENU & LANG overlay logic (UPDATE: overlay placed INSIDE .video-card in landscape) ----------
  let menuWasOpenBeforeLang = false;

  function placeOverlayInsideCard(overlay){
    if(overlay.parentNode !== card) card.appendChild(overlay);
    overlay.style.position = 'absolute';
    overlay.style.inset = '0';
    overlay.style.zIndex = '99999';
  }
  function placeOverlayBackToBody(overlay){
    if(overlay.parentNode !== document.body) document.body.appendChild(overlay);
    overlay.style.position = 'fixed';
    overlay.style.inset = '0';
    overlay.style.zIndex = '99999';
  }

  function openMenuOverlay(){
    if(!allowOverlayNow()) return;         // only in landscape/fullscreen
    // place overlay INSIDE the .video-card so it sits above the playing video
    placeOverlayInsideCard(menuOverlay);
    // show overlay (backdrop semi-transparent 50%)
    menuOverlay.classList.add('show');
    menuOverlay.setAttribute('aria-hidden','false');
    // ensure lang hidden
    langOverlay.classList.remove('show');
    langOverlay.setAttribute('aria-hidden','true');
    // hide native controls so overlay visually covers them
    hideAll();
  }
  function closeMenuOverlay(){
    menuOverlay.classList.remove('show');
    menuOverlay.setAttribute('aria-hidden','true');
    // restore controls
    showAll();
    // move overlay back to body when not in landscape/fullscreen (avoid showing it in portrait)
    if(!allowOverlayNow()) placeOverlayBackToBody(menuOverlay);
  }

  function openLangOverlay(){
    if(!allowOverlayNow()) return;
    menuWasOpenBeforeLang = menuOverlay.classList.contains('show');
    // place and show lang overlay inside card
    placeOverlayInsideCard(langOverlay);
    // hide menu and show lang
    menuOverlay.classList.remove('show');
    menuOverlay.setAttribute('aria-hidden','true');
    langOverlay.classList.add('show');
    langOverlay.setAttribute('aria-hidden','false');
    hideAll();
  }
  function closeLangOverlay(){
    langOverlay.classList.remove('show');
    langOverlay.setAttribute('aria-hidden','true');
    if(menuWasOpenBeforeLang){
      menuOverlay.classList.add('show');
      menuOverlay.setAttribute('aria-hidden','false');
      menuWasOpenBeforeLang = false;
    } else {
      showAll();
    }
    if(!allowOverlayNow()) placeOverlayBackToBody(langOverlay);
  }

  // menu button only works in landscape/fullscreen
  menuBtn.addEventListener('click', (e)=>{
    e.stopPropagation();
    openMenuOverlay();
  });

  if(menuCloseBtn) menuCloseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeMenuOverlay(); });
  if(menuBackdrop) menuBackdrop.addEventListener('click', ()=>{ closeMenuOverlay(); });
  if(langCloseBtn) langCloseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeLangOverlay(); });
  if(langBackdrop) langBackdrop.addEventListener('click', ()=>{ closeLangOverlay(); });

  if(menuLang) menuLang.addEventListener('click', (e)=>{ e.stopPropagation(); openLangOverlay(); });
  if(menuPip) menuPip.addEventListener('click', async (e)=>{
    e.stopPropagation();
    try {
      if(document.pictureInPictureElement) {
        await document.exitPictureInPicture();
        pipStatus.textContent = 'Activer';
      } else {
        try { await video.play(); } catch(_){}
        if (video.requestPictureInPicture) {
          await video.requestPictureInPicture();
          pipStatus.textContent = 'Désactiver';
        } else {
          if (video.webkitSetPresentationMode) {
            try { video.webkitSetPresentationMode('picture-in-picture'); pipStatus.textContent = 'Désactiver'; }
            catch(err){ console.warn('webkit PIP failed', err); alert('PiP non supporté par ce navigateur'); }
          } else {
            alert('Picture-in-Picture non supporté sur ce navigateur.');
          }
        }
      }
    } catch(err){
      console.warn('PiP failed', err);
      pipStatus.textContent = 'Erreur';
      setTimeout(()=>{ pipStatus.textContent = 'Activer'; }, 1400);
    } finally {
      setTimeout(()=> { if(document.pictureInPictureElement) closeMenuOverlay(); }, 300);
    }
  });

  if(langBackBtn) langBackBtn.addEventListener('click', (e)=>{ e.stopPropagation(); closeLangOverlay(); });

  window.addEventListener('keydown', (e)=>{
    if(e.key === 'Escape'){
      if(langOverlay.classList.contains('show')) closeLangOverlay();
      else if(menuOverlay.classList.contains('show')) closeMenuOverlay();
    }
  });

  // automatically close overlays when leaving landscape (so nothing appears in portrait)
  window.addEventListener('orientationchange', ()=>{
    if(!allowOverlayNow()){
      if(menuOverlay.classList.contains('show')) closeMenuOverlay();
      if(langOverlay.classList.contains('show')) closeLangOverlay();
      // ensure overlays are on body so portrait won't show them covering the whole page
      placeOverlayBackToBody(menuOverlay);
      placeOverlayBackToBody(langOverlay);
    }
  });
  window.addEventListener('resize', ()=>{
    if(!allowOverlayNow()){
      if(menuOverlay.classList.contains('show')) closeMenuOverlay();
      if(langOverlay.classList.contains('show')) closeLangOverlay();
      placeOverlayBackToBody(menuOverlay);
      placeOverlayBackToBody(langOverlay);
    }
  });

  // init
  tryAutoplay();
  showAll();

  // debug
  window.__player = { video, openMenuOverlay, closeMenuOverlay, openLangOverlay, closeLangOverlay, allowOverlayNow };
})();
</script>
</body>
</html>


****IMPORTANT : Iwant you to merge these two codes; in all places where there's a call to the Chrome custom player, the code should be replaced with your personal custom player.*** 


<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>TF-Stream</title>
  <link rel="manifest" href="/manifest.json?v=7">
  <link rel="icon" type="image/jpeg" href="https://tf-stream.pages.dev/asset/512.png" />
  <link rel="apple-touch-icon" href="https://tf-stream.pages.dev/asset/512.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{ --thumb-w: clamp(90px, 14vw, 160px); --thumb-aspect: calc(9/16); --thumb-h: calc(var(--thumb-w) * var(--thumb-aspect)); --thumb-radius: 10px; --card-gap: 15px; --bottom-space: 72px; }
    html, body { overscroll-behavior: none; touch-action: pan-y; height:100%; }
    body { margin:0; background:#000; color:#fff; font-family:'Roboto',sans-serif; overflow:hidden; padding-bottom:60px; }
    .header{padding:20px;text-align:center;position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(0,0,0,0.7);z-index:10;}
    .logo{font-size:28px;font-weight:bold;background:linear-gradient(90deg,#fff,#000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:blur(0.5px);}
    .filter-bar{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap;}
    .filter-btn{background:#222;color:#fff;border:none;padding:6px 14px;border-radius:30px;cursor:pointer;}
    .filter-btn.active{background:#444;}
    .search-container{display:flex;justify-content:center;padding:10px 20px;}
    .search-box{width:100%;max-width:500px;background:#1c1c1e;border:none;padding:12px 20px;border-radius:15px;color:#fff;font-size:16px;box-shadow:inset 0 0 5px #000;outline:none;}
    .content-area { padding:0; box-sizing:border-box; height: calc(100vh - 60px); }
    .video-list{ display:flex;flex-wrap:wrap;gap:var(--card-gap);padding:20px; padding-bottom: calc(var(--bottom-space) + 8px); justify-content:center;min-height:200px; max-height: calc(100vh - 140px); overflow-y:auto; -webkit-overflow-scrolling:touch; box-sizing:border-box; }
    .video-list::after{ content:""; display:block; height:var(--bottom-space); width:100%; }
    .video-card{position:relative;width:var(--thumb-w);background:#111;border-radius:8px;overflow:visible;cursor:pointer;transition:transform .18s;display:flex;flex-direction:column;align-items:stretch;}
    .video-card:hover{transform:scale(1.03);}
    .thumb-wrap{width:100%;height:var(--thumb-h);overflow:hidden;border-radius:var(--thumb-radius);background:#111;display:block;}
    .thumb-wrap img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;transform-origin:center center;}
    .card-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity .25s;border-radius:8px;}
    .video-card:hover .card-overlay{opacity:1;}
    .play-icon{font-size:40px;color:#fff;}
    .info{padding:6px;text-align:center;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .nav-bar{position:fixed;bottom:0;width:100%;background:#111;display:flex;justify-content:space-around;padding:10px 0;z-index:20;border-top:1px solid #333;}
    .nav-btn{background:none;border:none;color:#aaa;font-size:14px;text-align:center;flex:1;cursor:pointer;}
    .nav-btn.active{color:#fff;font-weight:bold;}
    #explorerView{ padding:20px; padding-bottom: calc(var(--bottom-space) + 8px); max-height: calc(100vh - 140px); overflow-y:auto;display:none;background:#000;-webkit-overflow-scrolling:touch;min-height:200px; box-sizing:border-box; }
    #explorerView::after{ content:""; display:block; height:var(--bottom-space); width:100%; }
    .post-card{background:#111;border-radius:15px;padding:15px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.7);}     
    .post-name{font-weight:700;font-size:17px;margin-bottom:8px;color:#fff;}
    .post-text{font-size:15px;color:#ddd;margin-bottom:10px;white-space:pre-wrap;}
    .social-section{margin-top:10px;padding-top:10px;border-top:1px solid #333;display:flex;justify-content:center;gap:15px;}
    .social-section img{width:40px;height:40px;}
    .overlay-fond{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:none;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto;z-index:999;}
    .modal-container{background:#111;border-radius:10px;padding:20px;max-width:700px;width:100%;box-shadow:0 4px 20px rgba(0,0,0,0.8);position:relative; max-height: calc(100vh - 80px); overflow-y:auto; -webkit-overflow-scrolling:touch;}
    .modal-container button{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
    .thumbnail{width:auto;max-width:100%;height:auto;max-height:70vh;object-fit:contain;border-radius:6px;margin-bottom:12px;}
    .modal-title{font-size:24px;font-weight:700;margin-bottom:8px;}
    .modal-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .season-list{position:absolute;top:60px;right:20px;background:#111;border-radius:6px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.7);display:none;z-index:1001;}
    .season-list button{width:100%;padding:10px;text-align:left;background:#222;color:#fff;border:none;border-bottom:1px solid #333;cursor:pointer;}
    .modal-info{background:#111;border-radius:6px;padding:12px;font-size:14px;color:#ddd;margin-bottom:12px;display:none;}
    .modal-episodes{display:grid;grid-template-columns:1fr;gap:18px; max-height: 50vh; overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom:8px;}
    .episode-item{background:rgba(0,0,0,0.6);padding:12px;border-radius:8px;cursor:pointer;transition:transform .2s;}
    .episode-item:hover{transform:scale(1.02);}
    .episode-item.active { background: rgba(200,200,200,0.3); }
    .episode-item.visited { background: rgba(50,50,50,0.4); color: #aaa; font-weight: normal; }
    .ad-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:1000;}
    .ad-container{background:#111;padding:20px;border-radius:10px;text-align:center;}
    .ad-container button{background:#444;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;}
    #splash { position: fixed; inset:0; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; animation: splashPop 1.7s forwards; pointer-events:auto; }
    .splash-logo { font-size:3rem; font-weight:bold;background:linear-gradient(90deg,#fff,#000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter: blur(0.5px); margin:0; animation:logoPop 1.7s ease-out forwards; }
    .splash-version { margin-top:0.5rem; color:#aaa; font-size:1rem; animation:logoPop 1.7s ease-out forwards; }
    @keyframes splashPop { 0%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
    @keyframes logoPop { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.2)} 80%{transform:scale(1.1)} 100%{opacity:0;transform:scale(1.1)} }
    .media-container { width:100%; height:auto; overflow:visible; padding:6px 0; background:transparent; display:flex; justify-content:center; align-items:center; }
    .media-container img, .media-container video { width:auto; height:auto; max-width:100%; max-height:80vh; object-fit:contain; display:block; margin:0 auto; border-radius:8px; }
    .post-card .media-container { padding:6px 0; }
    .post-card .media-container img { width:auto; height:auto; max-width:100%; max-height:360px; object-fit:contain; display:block; margin:0 auto; }
    .post-card .media-container video { width:auto; height:auto; max-width:100%; max-height:480px; object-fit:contain; display:block; border-radius:8px; }
    .notif-request { position:fixed;left:50%;transform:translateX(-50%);bottom:76px;background:#111;padding:12px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.7);z-index:10001;display:none;align-items:center;gap:8px; }
    .notif-request button{background:#222;border:1px solid #333;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer;}
    .notif-request small{display:block;color:#bbb;font-size:13px;margin-top:6px;text-align:center;}
    #tf-debug { position:fixed; left:8px; right:8px; bottom:8px; max-height:34vh; overflow:auto; background:rgba(0,0,0,0.85); color:#eee; border-radius:8px; padding:8px; font-size:12px; z-index:20000; display:none; border:1px solid rgba(255,255,255,0.04); }
    #tf-debug pre{ white-space:pre-wrap; word-break:break-word; margin:0; }
    .tf-debug-toggle{ position:Fixed; right:12px; bottom:12px; z-index:20010; background:#222; color:#fff; border-radius:20px; padding:6px 10px; font-size:12px; display:none; cursor:pointer; }
    input, textarea, select, .search-box { -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; user-select: none !important; }
    body, html { -webkit-touch-callout: none; }
    ::-webkit-scrollbar { display: none; }
    html { scrollbar-width: none; -ms-overflow-style: none; }
    * { -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; user-select: none !important; }
  </style>
</head>
<body>
  <div id="splash"><h1 class="splash-logo">TF-Stream</h1><p class="splash-version">D'H7 | Tergene</p></div>
  <div id="fondOverlay" class="overlay-fond" aria-hidden="true"></div>
  <div class="header" id="mainHeader">
    <div class="logo" id="appLogo">TF-Stream</div>
    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterCategory('Tout',event)">Tout</button>
      <button class="filter-btn" onclick="filterCategory('Film',event)">Film</button>
      <button class="filter-btn" onclick="filterCategory('Série',event)">Série</button>
      <button class="filter-btn" onclick="filterCategory('Anime',event)">Anime</button>
    </div>
    <div class="search-container">
      <input id="searchBox" class="search-box" type="text" placeholder="Rechèch..." autocomplete="off">
    </div>
  </div>
  <div class="content-area">
    <div class="video-list" id="videoList"></div>
    <div id="explorerView"></div>
  </div>
  <div class="nav-bar">
    <button class="nav-btn active" onclick="navigateTo('Accueil',event)">Accueil</button>
    <button class="nav-btn" onclick="navigateTo('Explorer',event)">Explorer</button>
  </div>
  <div id="adOverlay" class="ad-overlay">
    <div class="ad-container">
      <p>Publicité</p>
      <button id="adLinkBtn">En savoir plus</button>
      <button onclick="closeAd()">Fermer</button>
    </div>
  </div>
  <div id="notifRequest" class="notif-request" role="dialog" aria-hidden="true">
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="font-weight:700"></div>
      <button onclick="requestNotificationPermission('android')">Activer notifications</button>
     </div>
    <small id="notifRequestHint"></small>
  </div>
  <div id="tf-debug"><pre id="tf-debug-pre"></pre></div>
  <button id="tf-debug-toggle" class="tf-debug-toggle">Debug</button>
  <script>
const IMAGE_TIMEOUT = 7000;
const MAX_SPLASH_WAIT = 7000;
const NO_THUMB_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="288" viewBox="0 0 512 288"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ddd" font-family="Arial, Helvetica, sans-serif" font-size="28">No Thumb</text></svg>');
const adUrl = "https://www.effectivegatecpm.com/sb8frb30?key=b74cd3abdfc6db3be0c0b8d215fcb582";
const DEBUG = (new URLSearchParams(location.search)).get('debug') === '1';
function debugLog(...args){ if(!DEBUG) return; try{ const p=document.getElementById('tf-debug-pre'); p.textContent += args.map(a=>(typeof a === 'string'?a:JSON.stringify(a,null,2))).join(' ') + '\n\n'; document.getElementById('tf-debug').style.display='block'; document.getElementById('tf-debug-toggle').style.display='block'; }catch(e){} console.log(...args); }
document.getElementById('tf-debug-toggle')?.addEventListener('click', ()=>{ const el=document.getElementById('tf-debug'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; });
function slugify(text){ return String(text||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-'); }
function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }
function getText(obj, candidateKeys){ if(!obj) return ''; for(const k of candidateKeys){ if(obj[k]) return obj[k]; } const map={}; for(const p in obj) map[p.toLowerCase()] = obj[p]; for(const k of candidateKeys){ if(map[k.toLowerCase()]) return map[k.toLowerCase()]; } return ''; }
function findEpisodeArray(obj){ if(!obj || typeof obj !== 'object') return null; const candidateKeys = ['episodes','Episodes','Épisodes','episodes_list','sources','links','chapters','items','parts','streams','seasons']; for(const key of candidateKeys){ if(Array.isArray(obj[key]) && obj[key].length>0 && typeof obj[key][0] === 'object') return obj[key]; } for(const k in obj){ const v = obj[k]; if(Array.isArray(v) && v.length>0 && typeof v[0] === 'object'){ const keys = Object.keys(v[0]).map(s=>s.toLowerCase()); if(keys.includes('video')||keys.includes('url')||keys.includes('stream')||keys.includes('titre')||keys.includes('title')||keys.includes('description')||keys.includes('thumb')||keys.includes('source')) return v; } } return null; }
const videoListEl = document.getElementById('videoList');
const explorerEl = document.getElementById('explorerView');
const overlay = document.getElementById('fondOverlay');
const searchBox = document.getElementById('searchBox');
const adLinkBtn = document.getElementById('adLinkBtn');
const notifRequestEl = document.getElementById('notifRequest');
window.allData = [];
window.slugMap = {};
window._viewScroll = { accueil:0, explorer:0 };
window._shuffledOnce = false;
window._bodyScrollTop = 0;
window._sectionOrder = ['film','anime','série'];
window._explorerOrder = null;
function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function shuffleSections(){ const base = ['film','anime','série']; window._sectionOrder = shuffleArray(base.slice()); debugLog('shuffled sections', window._sectionOrder); }
function shuffleExplorerPosts(){ const posts = window.allData.filter(p => ((p.Catégorie||p.category||'').toString().toLowerCase() === 'poste')); const copy = posts.slice(); shuffleArray(copy); window._explorerOrder = copy; debugLog('shuffled explorer posts count', copy.length); }
function openDB(){ return new Promise((resolve,reject)=>{ const req=indexedDB.open('tfStream',1); req.onupgradeneeded=()=>{ const db=req.result; if(!db.objectStoreNames.contains('uploads')) db.createObjectStore('uploads',{keyPath:'id',autoIncrement:true}); }; req.onsuccess=()=>resolve(req.result); req.onerror=()=>reject(req.error); }); }
function getAllUploads(){ return openDB().then(db=>new Promise((res,rej)=>{ const tx=db.transaction('uploads','readonly'); const store=tx.objectStore('uploads'); const req=store.getAll(); req.onsuccess=()=>{ db.close(); res(req.result||[]); }; req.onerror=()=>{ db.close(); rej(req.error); }; })); }
function loadImageWithTimeout(url, timeout){ return new Promise((resolve,reject)=>{ if(!url) return reject(new Error('no url')); const img=new Image(); let settled=false; const timer=setTimeout(()=>{ if(!settled){ settled=true; img.src=''; resolve(NO_THUMB_SVG); } }, timeout); img.onload=()=>{ if(settled) return; settled=true; clearTimeout(timer); resolve(url); }; img.onerror=()=>{ if(settled) return; settled=true; clearTimeout(timer); resolve(NO_THUMB_SVG); }; img.src=url; }); }
function setImageSrcWithTimeout(imgEl, url, timeout){ if(!imgEl) return; if(!url){ imgEl.dataset.src = NO_THUMB_SVG; imgEl.src = NO_THUMB_SVG; return; } if(imgEl.dataset.src === url) return; imgEl.dataset.src = url; let loaded=false; const timed=setTimeout(()=>{ if(!loaded){ imgEl.src = NO_THUMB_SVG; imgEl.dataset.src = NO_THUMB_SVG; } }, timeout); const onload=()=>{ loaded=true; clearTimeout(timed); imgEl.removeEventListener('load',onload); imgEl.removeEventListener('error',onerror); }; const onerror=()=>{ loaded=true; clearTimeout(timed); imgEl.src = NO_THUMB_SVG; imgEl.dataset.src = NO_THUMB_SVG; imgEl.removeEventListener('load',onload); imgEl.removeEventListener('error',onerror); }; imgEl.addEventListener('load',onload); imgEl.addEventListener('error',onerror); imgEl.src=url; }
async function loadAllData(){
  try{
    const filesResp = await fetch('index.json', {cache:'no-cache'}).catch(()=>null);
    if(!filesResp || !filesResp.ok) { debugLog('index.json non trouvé ou erreur'); return; }
    const files = await filesResp.json();
    const jsons = await Promise.all((files||[]).map(f => fetch(f).then(r=>r.ok? r.json(): null).catch(()=>null)));
    window.allData = [];
    jsons.forEach(d=>{ if(!d) return; if(Array.isArray(d)) window.allData.push(...d); else window.allData.push(d); });
    const uploads = await getAllUploads().catch(()=>[]);
    (uploads||[]).forEach(u=>{
      const item={Titre:u.title||('Upload '+(u.id||'')),Name:u.title||('Upload '+(u.id||'')),Catégorie:'poste',Url:u.url||'', 'Url Thumb':u.thumb||'', Description:u.description||'', uploaded:true, __uploadedId:u.id};
      window.allData.unshift(item);
    });
    if(window.allData.length === 0 && window.sampleData) window.allData = window.sampleData.slice();
    if(!window._shuffledOnce){ shuffleArray(window.allData); window._shuffledOnce = true; }
    prepareSlugMap();
    debugLog('loadAllData — items:', window.allData.length);
  }catch(e){ debugLog('loadAllData erreur', e); }
}
function prepareSlugMap(){
  window.slugMap = {};
  window.allData.forEach((it,i)=>{
    const title = it.Titre||it.Name||it.Title||it['Nom']||('item-'+i);
    const base = slugify(title||('item-'+i));
    let slug = base || ('item-'+i);
    let k = 1;
    while(window.slugMap[slug]){ slug = base + '-' + k; k++; }
    window.slugMap[slug] = { item: it, index: i, slug: slug };
    window.slugMap[slug.toLowerCase()] = window.slugMap[slug];
    it.__slug = slug;
  });
  debugLog('prepareSlugMap keys sample:', Object.keys(window.slugMap).slice(0,50));
}
function displayVideos(videos){
  setTimeout(()=>_renderDisplayVideos(videos), 60);
}
function _renderDisplayVideos(videos){
  const prevScroll = videoListEl.scrollTop || 0;
  const activeBtn=document.querySelector('.filter-btn.active');
  const cat = activeBtn? activeBtn.textContent.toLowerCase() : 'tout';
  let visible;
  if(cat === 'tout'){
    const buckets = { film: [], anime: [], série: [], other: [] };
    videos.forEach(v=>{
      const c = (v.Catégorie||v.category||'').toString().toLowerCase();
      if(c === 'poste') return;
      if(c === 'film') buckets.film.push(v);
      else if(c === 'anime' || c === 'animé') buckets.anime.push(v);
      else if(c === 'série' || c === 'serie') buckets['série'].push(v);
      else buckets.other.push(v);
    });
    visible = [];
    const order = Array.isArray(window._sectionOrder) && window._sectionOrder.length === 3 ? window._sectionOrder : ['film','anime','série'];
    order.forEach(k=>{
      if(k === 'film') visible.push(...buckets.film);
      else if(k === 'anime') visible.push(...buckets.anime);
      else if(k === 'série') visible.push(...buckets['série']);
    });
    visible.push(...buckets.other);
  } else {
    visible = videos.filter(v=>{
      const c = (v.Catégorie||v.category||'').toString().toLowerCase();
      if(c==='poste') return false;
      if(cat==='film') return c==='film';
      if(cat==='série') return (c==='série' || c==='serie');
      if(cat==='anime') return (c==='anime' || c==='animé');
      return false;
    });
  }
  const frag = document.createDocumentFragment();
  if(visible.length===0){ videoListEl.innerHTML='<div style="color:#888;width:100%;text-align:center;padding:60px 0">Aucun contenu trouvé</div>'; return; }
  visible.forEach(v=>{
    const card=document.createElement('div'); card.className='video-card';
    const thumbUrl = v['Url Thumb'] || v.thumb || NO_THUMB_SVG;
    const title = escapeHtml(v.Titre||v.Name||v.Texte||'Sans titre');
    card.innerHTML = `<div class="thumb-wrap"><img loading="lazy" alt=""></div><div class="card-overlay"><span class="play-icon">▶</span></div><div class="info">${title}</div>`;
    const img = card.querySelector('img');
    setImageSrcWithTimeout(img, thumbUrl, IMAGE_TIMEOUT);
    card.addEventListener('click', ()=>{ showPostModal(v, window.allData.indexOf(v)); });
    frag.appendChild(card);
  });
  videoListEl.innerHTML = '';
  videoListEl.appendChild(frag);
  videoListEl.scrollTop = prevScroll;
}
function displayExplorer(){
  explorerEl.innerHTML = '';
  let posts = window.allData.filter(p => (p.Catégorie||p.category||'').toString().toLowerCase() === 'poste');
  if(Array.isArray(window._explorerOrder) && window._explorerOrder.length > 0){
    const mapKey = (it)=>(it.__uploadedId?('id:'+it.__uploadedId):(it.Url?('url:'+it.Url):('title:'+ (it.Titre||it.Name||''))));
    const allMap = new Map();
    posts.forEach(p => allMap.set(mapKey(p), p));
    const ordered = [];
    window._explorerOrder.forEach(pRef=>{
      const key = mapKey(pRef);
      if(allMap.has(key)) ordered.push(allMap.get(key));
    });
    posts.forEach(p => { if(!ordered.includes(p)) ordered.push(p); });
    posts = ordered;
  }
  if(posts.length === 0){ explorerEl.innerHTML='<div style="color:#888;width:100%;text-align:center;padding:60px 0">Aucun poste</div>'; return; }
  posts.forEach(post=>{
    const thumbUrl = post['Url Thumb']||NO_THUMB_SVG;
    const videoUrl = post.Previously || post['Previously '] || post.video || post.Url || '';
    const card = document.createElement('div'); card.className='post-card';
    card.innerHTML = `<div class="media-container"><img class="thumb" alt=""></div><div class="post-name">${escapeHtml(post.Name||post.Titre||'')}</div><div class="post-text">${escapeHtml(post.Description||post.Bio||'')}</div>`;
    explorerEl.appendChild(card);
    const thumb = card.querySelector('.thumb');
    setImageSrcWithTimeout(thumb, thumbUrl, IMAGE_TIMEOUT);
    card.addEventListener('click', (e)=>{ e.stopPropagation(); });
    if(thumb){
      thumb.style.cursor = videoUrl ? 'pointer' : 'default';
      thumb.addEventListener('click', (e)=>{ e.stopPropagation(); if(!videoUrl) return; const media = card.querySelector('.media-container'); if(media.querySelector('video')) return; const v = document.createElement('video'); v.src = videoUrl; v.controls=true; v.autoplay=false; v.playsInline=true; v.muted=false; v.className='explorer-video'; v.setAttribute('controlsList','nodownload'); v.setAttribute('playsinline',''); media.innerHTML=''; media.appendChild(v); v.focus&&v.focus(); }, {passive:true});
    }
  });
  displaySocialLinks();
}
function displaySocialLinks(){ const s = document.createElement('div'); s.className='social-section'; s.innerHTML=`<a href="https://www.facebook.com" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=118467&format=png&color=ffffff"/></a>`; explorerEl.appendChild(s); }
function navigatePath(path){ path = path || '/Accueil'; if(location.pathname !== path) history.pushState({},'', path); else handlePath(path); }
function filterCategory(_, e){ try{ shuffleSections(); }catch(e){} document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); displayVideos(window.allData); navigatePath('/Accueil'); }
function filterSearch(val){ const results = window.allData.filter(i => (i.Titre||i.Name||i.Texte||'').toLowerCase().includes(val.toLowerCase())); displayVideos(results); navigatePath('/search'); }
function saveCurrentScroll(){ if(videoListEl.style.display !== 'none') window._viewScroll.accueil = videoListEl.scrollTop || 0; if(explorerEl.style.display !== 'none') window._viewScroll.explorer = explorerEl.scrollTop || 0; }
function navigateTo(sec, e){
  saveCurrentScroll();
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  if(e && e.target) e.target.classList.add('active');
  videoListEl.style.display='none'; explorerEl.style.display='none'; document.querySelector('.filter-bar').style.display='none'; document.querySelector('.search-container').style.display='none';
  if(sec==='Accueil'){
    if(e) { try{ shuffleSections(); }catch(err){} }
    document.querySelector('.filter-bar').style.display='flex';
    document.querySelector('.search-container').style.display='flex';
    displayVideos(window.allData);
    videoListEl.style.display='flex';
    navigatePath('/Accueil');
    return;
  }
  if(sec==='Explorer'){
    if(e) { try{ shuffleExplorerPosts(); }catch(err){} }
    displayExplorer();
    explorerEl.style.display='block';
    document.querySelector('.search-container').style.display='flex';
    navigatePath('/Explorer');
    return;
  }
}
function lockBodyScroll(){ window._bodyScrollTop = window.scrollY || window.pageYOffset || 0; document.documentElement.style.top = `-${window._bodyScrollTop}px`; document.documentElement.style.position = 'fixed'; document.documentElement.style.width = '100%'; }
function unlockBodyScroll(){ document.documentElement.style.position = ''; document.documentElement.style.top = ''; const restore = window._bodyScrollTop || 0; window._bodyScrollTop = 0; window.scrollTo(0, restore); }
function hideBackgroundForModal(){ ['.header','.content-area','.nav-bar'].map(s=>document.querySelector(s)).filter(Boolean).forEach(el=>{ el.setAttribute('aria-hidden','true'); try{ el.inert=true; }catch(e){} el.style.pointerEvents='none'; el.style.visibility='hidden'; el.style.userSelect='none'; }); videoListEl.style.overflow='hidden'; explorerEl.style.overflow='hidden'; overlay.style.display='flex'; }
function restoreBackgroundAfterModal(){ ['.header','.content-area','.nav-bar'].map(s=>document.querySelector(s)).filter(Boolean).forEach(el=>{ el.removeAttribute('aria-hidden'); try{ el.inert=false; }catch(e){} el.style.pointerEvents=''; el.style.visibility=''; el.style.userSelect=''; }); videoListEl.style.overflow=''; explorerEl.style.overflow=''; overlay.style.display='none'; }
async function tryEnterFullscreen(el){
  try{ if(el && el.requestFullscreen) await el.requestFullscreen({navigationUI:'hide'}); }catch(e){}
}
async function activateVideo(src, episodeThumb){
  const modalVideo = document.getElementById('modalVideo'), modalImg=document.getElementById('modalImg');
  if(!modalVideo) return;
  if(episodeThumb) setImageSrcWithTimeout(modalImg, episodeThumb, IMAGE_TIMEOUT);
  modalImg.style.display='none'; modalVideo.style.display='block';
  try{ modalVideo.pause(); }catch(e){}
  modalVideo.src = src; modalVideo.load(); modalVideo.muted=false; modalVideo.playsInline=true; modalVideo.controls=true;
  try{ modalVideo.setAttribute('controlsList','nodownload'); }catch(e){}
  try{ await tryEnterFullscreen(modalVideo); }catch(e){}
  try{ const p = modalVideo.play(); if(p && p.catch) p.catch(()=>{}); }catch(e){}
}
function activateImage(poster){ const modalVideo=document.getElementById('modalVideo'), modalImg=document.getElementById('modalImg'); if(!modalVideo) return; try{ modalVideo.pause(); }catch(e){} modalVideo.removeAttribute('src'); modalVideo.load(); modalVideo.style.display='none'; modalImg.style.display='block'; if(poster) setImageSrcWithTimeout(modalImg, poster, IMAGE_TIMEOUT); }
function showPostModal(post, postIndex, opts={push:true}){
  const slug = post.__slug || slugify((post.Titre||post.Name||('item-'+postIndex)));
  overlay.innerHTML =
    `<div class="modal-container" role="dialog" aria-modal="true">
      <button id="modalBackBtn">← Retour</button>
      <div class="media-container" id="mediaWrap">
        <img id="modalImg" class="thumbnail" src="${post['Url Thumb']||NO_THUMB_SVG}" alt="poster">
        <video id="modalVideo" class="thumbnail" style="display:none;" muted controls playsinline controlsList="nodownload"></video>
      </div>
      <div id="modalTitle" class="modal-title"></div>
      <div class="modal-controls">
        <button id="infoBtn">Voir plus…</button>
        <button id="seasonBtn">Saison 1</button>
      </div>
      <div id="seasonList" class="season-list"></div>
      <div id="modalInfo" class="modal-info"></div>
      <div id="episodeList" class="modal-episodes"></div>
    </div>`;
  overlay.style.overflow='auto';
  hideBackgroundForModal();
  lockBodyScroll();
  const modalImg=document.getElementById('modalImg'), modalVideo=document.getElementById('modalVideo'), titleEl=document.getElementById('modalTitle'),
        infoBtn=document.getElementById('infoBtn'), seasonBtn=document.getElementById('seasonBtn'), seasonList=document.getElementById('seasonList'),
        infoEl=document.getElementById('modalInfo'), epList=document.getElementById('episodeList');
  titleEl.textContent = post.Titre||post.Name||'';
  const globalDescription = getText(post, ['Description','description','Synopsis','synopsis','Summary','Résumé','Resume','Desc','desc','Plot','plot','Overview','overview','About','about']);
  const globalBio         = getText(post, ['Bio','bio','Biographie','biographie','Author','author']);
  const globalInfo        = getText(post, ['Info','info','Infos','infos','Details','details','Runtime','runtime','Year','year']);
  let saisons = post.Saisons || post.Seasons || post.saisons || post.seasons || [];
  if((!saisons || saisons.length === 0)){
    const topEps = post.Episodes || post.episodes || post['Épisodes'] || post['episodes'] || [];
    if(Array.isArray(topEps) && topEps.length) saisons = [{ episodes: topEps }];
  }
  if((!saisons || saisons.length === 0) || (Array.isArray(saisons) && saisons.length===0)){
    const found = findEpisodeArray(post);
    if(found) saisons = [{ episodes: found }];
  }
  if(Array.isArray(saisons) && saisons.length>0){
    saisons = saisons.map(s=>{
      const epsRaw = s.episodes || s.Episodes || s['episodes'] || [];
      let eps = Array.isArray(epsRaw) ? epsRaw.slice() : [];
      if(eps.length>0 && typeof eps[0] === 'string'){
        eps = eps.map(u => ({ video: u, description: '' }));
      }
      eps = eps.map(e=> typeof e==='object' ? e : { title: String(e||''), video: '' });
      return Object.assign({}, s, { episodes: Array.isArray(eps) ? eps : [] });
    });
  }
  const storageKey = `post-${slug}-state`;
  const saved = (function(){ try{ return JSON.parse(localStorage.getItem(storageKey)||'{}'); }catch(e){ return {}; } })();
  let playbackTimes = saved.playbackTimes||{};
  let visited = saved.visited||{};
  let currentSeason = 0, selectedEpEl = null;
  function saveState(){ const last = (modalVideo.style.display!=='none' && modalVideo.src) ? modalVideo.src : (saved.lastVideoUrl||''); try{ localStorage.setItem(storageKey, JSON.stringify({ lastVideoUrl: last, playbackTimes, visited })); }catch(e){} }
  function renderInfo(){
    const s = saisons[currentSeason] || {};
    const desc = getText(s, ['description','Description','synopsis','Synopsis']) || globalDescription || '';
    const bio  = getText(s, ['bio','Bio']) || globalBio || '';
    const info = getText(s, ['info','Info']) || globalInfo || '';
    infoEl.innerHTML = `<strong>Description:</strong> ${escapeHtml(desc||'—')}<br><strong>Bio:</strong> ${escapeHtml(bio||'—')}<br><strong>Info:</strong> ${escapeHtml(info||'—')}`;
    infoEl.style.display = 'block';
  }
  infoBtn.onclick = ()=> infoEl.style.display = infoEl.style.display==='block' ? 'none' : 'block';
  seasonList.innerHTML = '';
  if(saisons.length > 1){
    saisons.forEach((s,i)=>{ const b=document.createElement('button'); b.textContent=`Saison ${i+1}`; b.onclick = ()=>{ currentSeason = i; seasonBtn.textContent = `Saison ${i+1}`; renderInfo(); renderEpisodes(); seasonList.style.display = 'none'; }; seasonList.appendChild(b); });
    seasonBtn.style.display = 'inline-block';
    seasonBtn.onclick = ()=> seasonList.style.display = seasonList.style.display==='block'?'none':'block';
    seasonBtn.textContent = `Saison ${currentSeason+1}`;
  } else { seasonBtn.style.display='none'; }
  function renderEpisodes(){
    epList.innerHTML = '';
    const eps = (saisons[currentSeason] && saisons[currentSeason].episodes) || [];
    if(!eps || eps.length === 0){
      epList.innerHTML = `<div style="color:#999;padding:8px;cursor:pointer;" id="retryEpisodes">Aucun épisode disponible. Cliquez pour réessayer</div>`;
      const retry = document.getElementById('retryEpisodes');
      if(retry){
        retry.addEventListener('click', async (e)=>{
          e.stopPropagation();
          try{
            await refreshData();
            closeModal();
            handlePath('/'+slug);
          }catch(err){ debugLog('retryEpisodes error', err); }
        }, {passive:true});
      }
      return;
    }
    eps.forEach((ep,i)=>{
      const d = document.createElement('div'); d.className='episode-item';
      const epDesc = getText(ep, ['description','Description','title','Title','Titre','titre','name','Name']) || '';
      d.innerHTML = `<strong>Episode ${i+1}</strong><div>${escapeHtml(epDesc||'')}</div>`;
      const visKey = ep.video || ep.url || ep.stream || ep['Video'] || ep['URL'] || ('ep-'+i);
      if(visited[visKey]) d.classList.add('visited');
      d.onclick = ()=>{
        if(selectedEpEl) selectedEpEl.classList.remove('active');
        d.classList.add('active'); selectedEpEl = d;
        const newSrc = ep.video || ep.url || ep.stream || ep['Video'] || ep['URL'] || '';
        if(!newSrc) return;
        try{ window.open(adUrl, '_blank', 'noopener,noreferrer'); }catch(e){}
        tryEnterFullscreen(modalVideo).catch(()=>{});
        setTimeout(()=>{ activateVideo(newSrc, ep.thumb || ep.thumbnail || post['Url Thumb'] || ''); }, 300);
        const onTime = ()=>{
          try{ if(modalVideo.currentTime > 7){ d.classList.add('visited'); visited[visKey] = true; modalVideo.removeEventListener('timeupdate', onTime); saveState(); } }catch(e){}
        };
        modalVideo.addEventListener('timeupdate', onTime);
        saveState();
      };
      epList.appendChild(d);
    });
  }
  renderInfo();
  renderEpisodes();
  debugLog('showPostModal keys:', Object.keys(post).slice(0,50));
  debugLog('saisons length:', saisons.length, 'sample episodes:', (saisons[0] && saisons[0].episodes && saisons[0].episodes.slice(0,3)) || []);
  if(saved && saved.lastVideoUrl){
    let found=false;
    for(let si=0; si<(saisons.length||0) && !found; si++){
      const eps=(saisons[si] && saisons[si].episodes)||[];
      for(let ei=0; ei<eps.length; ei++){
        if(eps[ei] && (eps[ei].video === saved.lastVideoUrl || eps[ei].url === saved.lastVideoUrl)){
          currentSeason = si; seasonBtn.textContent = `Saison ${si+1}`; renderInfo(); renderEpisodes();
          const el = epList.children[ei];
          if(el){ el.click(); found = true; break; }
        }
      }
    }
    if(!found){
      const url = saved.lastVideoUrl;
      if(url && (url.match(/\.(mp4|webm|m3u8|mpd)(\?|$)/i) || url.startsWith('blob:') || url.startsWith('http'))){
        activateVideo(url, post['Url Thumb']||'');
        const restoreTime2 = ()=>{ try{ if(saved.playbackTimes && saved.playbackTimes[url]) modalVideo.currentTime = saved.playbackTimes[url]; else modalVideo.currentTime = 0; }catch(e){} modalVideo.removeEventListener('loadedmetadata', restoreTime2); };
        modalVideo.addEventListener('loadedmetadata', restoreTime2);
      } else { activateImage(post['Url Thumb']||''); }
    }
  } else { modalImg.style.display='block'; modalVideo.style.display='none'; }
  if(opts.push !== false){
    const path = '/' + slug;
    if(location.pathname !== path) history.pushState({},'', path);
  } else {
    history.replaceState({},'', '/'+slug);
  }
  document.getElementById('modalBackBtn').onclick = ()=>{
    try{ modalVideo.pause(); }catch(e){}
    activateImage(post['Url Thumb']||'');
    try{ if(document.fullscreenElement) document.exitFullscreen(); }catch(e){}
    unlockBodyScroll();
    restoreBackgroundAfterModal();
    navigatePath('/Accueil');
    closeModal();
  };
}
function closeModal(){ overlay.style.display='none'; overlay.innerHTML=''; overlay.setAttribute('aria-hidden','true'); overlay.style.overflow=''; unlockBodyScroll(); restoreBackgroundAfterModal(); }
async function handlePath(rawPath){
  const p = String(rawPath||location.pathname||'').replace(/^\/+/,''), lower = (p||'').toLowerCase();
  if(!p || lower === 'accueil'){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.nav-btn')[0]?.classList.add('active');
    document.querySelector('.filter-bar').style.display='flex';
    document.querySelector('.search-container').style.display='flex';
    displayVideos(window.allData);
    videoListEl.style.display='flex';
    explorerEl.style.display='none';
    closeModal();
    return;
  }
  if(lower==='explorer' || lower==='explore'){
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.nav-btn')[1]?.classList.add('active');
    document.querySelector('.filter-bar').style.display='none';
    document.querySelector('.search-container').style.display='flex';
    displayExplorer();
    explorerEl.style.display='block';
    videoListEl.style.display='none';
    closeModal();
    return;
  }
  if(lower==='search'){ closeModal(); return; }
  const normalized = slugify(p);
  let info = window.slugMap[normalized] || window.slugMap[p] || window.slugMap[p.toLowerCase()];
  if(info && info.item){ showPostModal(info.item, info.index, {push:false}); return; }
  await loadAllData();
  info = window.slugMap[normalized] || window.slugMap[p] || window.slugMap[p.toLowerCase()];
  if(info && info.item){ showPostModal(info.item, info.index, {push:false}); return; }
  closeModal();
  displayVideos(window.allData);
  videoListEl.style.display='flex';
  explorerEl.style.display='none';
}
window.addEventListener('popstate', ()=> handlePath(location.pathname));
window.addEventListener('load', async ()=>{
  try{
    const splash = document.getElementById('splash');
    const splashRemover = (function(){
      let removed=false;
      return function removeSplash(){
        if(removed) return; removed = true;
        try{ if(splash){ splash.style.pointerEvents='none'; if(splash.parentNode) splash.parentNode.removeChild(splash); } }catch(e){}
        prepareSlugMap();
        try{ shuffleSections(); }catch(e){}
        displayVideos(window.allData);
        showNotifPromptIfNeeded();
      };
    })();
    const loadPromise = loadAllData();
    const maxWait = new Promise(res => setTimeout(res, MAX_SPLASH_WAIT));
    await Promise.race([loadPromise, maxWait]);
    splashRemover();
    (async function(){
      try{
        if('Notification' in window && Notification.permission !== 'granted'){
          const res = await Notification.requestPermission();
          if(res === 'granted'){ try{ onNotificationsGrantedTriggerQueue(); }catch(e){} }
        } else if('Notification' in window && Notification.permission === 'granted'){
          try{ onNotificationsGrantedTriggerQueue(); }catch(e){}
        }
      }catch(e){}
    })();
    setTimeout(()=>{ handlePath(location.pathname); }, 50);
  }catch(e){ debugLog('load() erreur', e); }
});
searchBox.addEventListener('keydown', function(e){ if(e.key==='Enter'){ const val=this.value.trim(); if(val==='') return; filterSearch(val); }});
searchBox.addEventListener('input', function(){ const v=this.value||''; if(v.startsWith('/')) return; showSearchSpinner(); clearTimeout(window.__tf_search_timeout); window.__tf_search_timeout=setTimeout(()=>{ filterSearch(v); hideSearchSpinner(); },350); });
function showSearchSpinner(){ if(document.getElementById('tf-search-spinner'))return; const spinner=document.createElement('div'); spinner.id='tf-search-spinner'; spinner.style.cssText='position:fixed;top:16px;left:50%;transform:translateX(-50%);width:40px;height:40px;border-radius:20px;z-index:10000;display:flex;align-items:center;justify-content:center;'; spinner.innerHTML='<div style="width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.15);border-top-color:#fff;animation:tfspin 0.9s linear infinite"></div>'; document.body.appendChild(spinner); const style=document.createElement('style'); style.id='tf-search-style'; style.innerHTML='@keyframes tfspin{to{transform:rotate(360deg);}}'; document.head.appendChild(style); }
function hideSearchSpinner(){ const s=document.getElementById('tf-search-spinner'); if(s) s.remove(); const st=document.getElementById('tf-search-style'); if(st) st.remove(); }
function refreshData(){ return loadAllData().then(()=>{ displayVideos(window.allData); }); }
if(adLinkBtn) adLinkBtn.addEventListener('click', ()=>{ try{ window.open(adUrl, '_blank', 'noopener,noreferrer'); }catch(e){} });
function closeAd(){ const ad = document.getElementById('adOverlay'); if(ad) ad.style.display='none'; }
function isInAppBrowser(){ const ua = navigator.userAgent || ''; return /FBAN|FBAV|Instagram|wv|WebView|FB_IAB|Twitter|Pinterest|Line/i.test(ua); }
function isiOS(){ return /iP(hone|od|ad)/i.test(navigator.userAgent); }
function iOSVersion(){ const m = navigator.userAgent.match(/OS (\d+)_?(\d+)?/); if(!m) return null; return parseFloat(`${m[1]}.${m[2] || 0}`); }
function showEnableInstructions(){ let msg = 'Les notifications sont bloquées pour ce site.\n\n'; if(navigator.userAgent.includes('Android')){ msg += 'Chrome Android: Menu → Paramètres du site → Notifications → autoriser.\n'; } else if(isiOS()){ msg += 'iOS: ouvre Réglages → Safari → Notifications (ou ouvre le site dans Safari et utilise les options d’affichage). Ajoute à l’écran d’accueil si besoin.\n'; } else { msg += 'Vérifie Paramètres du navigateur → Notifications → autoriser pour ce site.\n'; } msg += '\nSi tu es dans un navigateur intégré (Facebook/Instagram), ouvre le site dans Chrome ou Safari.'; alert(msg); }
function showNotifPromptIfNeeded(){
  try{
    const asked = localStorage.getItem('tf_notif_asked_v2');
    if((!('Notification' in window)) || (Notification && Notification.permission === 'granted')) return;
    if(asked) return;
    if(isiOS()){
      const v = iOSVersion();
      if(v && v < 16.4) document.getElementById('notifRequestHint').textContent = 'iOS ancienne version — la réception des notifications web peut ne pas être supportée. Mets à jour iOS ou ouvre dans Safari/ajoute à l’écran d’accueil.';
      else document.getElementById('notifRequestHint').textContent = 'Pour iOS : il se peut que tu doives "Ajouter à l’écran d’accueil" pour recevoir certaines notifications.';
    }
    notifRequestEl.style.display = 'flex';
    notifRequestEl.setAttribute('aria-hidden','false');
  }catch(e){}
}
function hideNotifRequest(){ notifRequestEl.style.display='none'; notifRequestEl.setAttribute('aria-hidden','true'); localStorage.setItem('tf_notif_asked_v2','1'); }
async function requestNotificationPermission(platform){
  try{
    localStorage.setItem('tf_notif_asked_v2','1');
    notifRequestEl.style.display='none';
    if(!('Notification' in window)){ alert('Notifications non supportées par ce navigateur.'); return; }
    if(isInAppBrowser()){ alert('Les notifications ne fonctionnent souvent pas dans les navigateurs intégrés (Facebook, Instagram, etc.). Ouvre le site dans Chrome/Edge/Safari pour activer les notifications.'); return; }
    if(Notification.permission === 'denied'){ showEnableInstructions(); return; }
    const result = await Notification.requestPermission();
    if(result === 'granted'){ try{ onNotificationsGrantedTriggerQueue(); }catch(e){} alert('Notifications activées.'); } else if(result === 'denied'){ alert('Notifications refusées — tu peux les activer depuis les réglages du navigateur.'); } else { showNotifPromptIfNeeded(); }
  }catch(e){}
}
async function sendImmediateNotification(){
  try{
    const arr = (window.allData||[]).filter(it=>{ const c=(it.Catégorie||it.category||'').toString().toLowerCase(); return c && c!=='poste'; });
    if(!arr || arr.length===0) return;
    const item = arr[Math.floor(Math.random()*arr.length)];
    const title = item && (item.Titre||item.Name) ? `TF-Stream vous propose ${item.Titre||item.Name}` : 'TF-Stream';
    const body = item && (item.Description||item.Bio) ? (item.Description||item.Bio).slice(0,120) : 'Cliquez pour découvrir.';
    const image = item && (item['Url Thumb']||item.thumb) ? new URL(item['Url Thumb']||item.thumb, location.origin).href : undefined;
    const slug = item && item.__slug ? item.__slug : undefined;
    const payload = { title, body, image, icon: image || undefined, badge: 'https://tf-stream.pages.dev/asset/notification.png', tag: 'tfstream-welcome', data: { slug } };
    if(navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({ type:'SHOW_NOTIFICATION', payload }); } else { try{ new Notification(payload.title, { body: payload.body, icon: payload.icon, image: payload.image, badge: payload.badge, data: payload.data }); }catch(e){} }
  }catch(e){}
}
function showNotificationDirect(payload){
  try{
    if (navigator.serviceWorker && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({ type: 'SHOW_NOTIFICATION', payload });
      markAsSent(payload);
      return;
    }
  }catch(e){}
  try{
    const opt = { body: payload.body || '', icon: payload.icon || payload.image || 'https://pub-46b5efc7a2f74e6797b554c867465fc0.r2.dev/1764678713115-TF-Notif.png', image: payload.image, data: payload.data || {} };
    new Notification(payload.title || 'TF-Stream', opt);
    markAsSent(payload);
  }catch(e){}
}
function pickNextNotificationFromStorage(){
  try{
    const raw = localStorage.getItem('tf_notifications');
    if(!raw) return null;
    const list = JSON.parse(raw);
    if(!Array.isArray(list) || list.length === 0) return null;
    const sentRaw = localStorage.getItem('tf_notif_sent') || '{}';
    let sent = {};
    try{ sent = JSON.parse(sentRaw); }catch(e){ sent = {}; }
    for(const it of list){
      const id = it.slug || (it.title || it.name || '').toString();
      if(!id) continue;
      if(sent[id]) continue;
      return {
        title: it.title || (`TF-Stream vous propose ${it.name||it.slug||''}`),
        body: it.body || it.description || '',
        image: it.thumb || it.image,
        icon: it.thumb || 'https://tf-stream.pages.dev/asset/notification.png',
        badge: 'https://tf-stream.pages.dev/asset/notification.png',
        tag: it.tag || ('tfstream-'+(it.slug||id)),
        data: { slug: it.slug }
      };
    }
    const NOTIF_CYCLE = true;
    if(NOTIF_CYCLE){
      try{ localStorage.setItem('tf_notif_sent','{}'); }catch(e){}
      for(const it of list){
        const id = it.slug || (it.title || it.name || '').toString();
        if(!id) continue;
        return {
          title: it.title || (`TF-Stream vous propose ${it.name||it.slug||''}`),
          body: it.body || it.description || '',
          image: it.thumb || it.image,
          icon: it.thumb || 'https://tf-stream.pages.dev/asset/notification.png',
          badge: 'https://tf-stream.pages.dev/asset/notification.png',
          tag: it.tag || ('tfstream-'+(it.slug||id)),
          data: { slug: it.slug }
        };
      }
    }
    return null;
  }catch(e){
    return null;
  }
}
function markAsSent(item){
  try{
    const id = (item && item.data && item.data.slug) ? item.data.slug : (item.title||'').toString();
    if(!id) return;
    const sentRaw = localStorage.getItem('tf_notif_sent') || '{}';
    let sent = {};
    try{ sent = JSON.parse(sentRaw); }catch(e){ sent = {}; }
    sent[id] = Date.now();
    localStorage.setItem('tf_notif_sent', JSON.stringify(sent));
  }catch(e){}
}
async function periodicNotifyEveryInterval(){
  try{
    if(!('Notification' in window)) return;
    if(Notification.permission !== 'granted') return;
    const next = pickNextNotificationFromStorage();
    if(!next) return;
    showNotificationDirect(next);
  }catch(e){}
}
function startPeriodicNotificationsIfAllowed(intervalMs = 2 * 60 * 1000){
  try{
    if(!('Notification' in window)) return;
    if(Notification.permission !== 'granted') return;
    periodicNotifyEveryInterval();
    if(!window._tf_notif_interval) window._tf_notif_interval = setInterval(periodicNotifyEveryInterval, intervalMs);
  }catch(e){ console.warn(e); }
}
function enqueueNotification(payload){
  try{
    if(navigator.serviceWorker && navigator.serviceWorker.controller){
      navigator.serviceWorker.controller.postMessage({ type: 'ENQUEUE_NOTIFICATION', payload });
    } else {
      navigator.serviceWorker.ready.then(reg => {
        if(reg.active) reg.active.postMessage({ type: 'ENQUEUE_NOTIFICATION', payload });
      }).catch(()=>{ });
    }
  }catch(e){ console.warn('enqueueNotification failed', e); }
}
function pollAndEnqueueNotifications(){
  try{
    const raw = localStorage.getItem('tf_notifications');
    if(!raw) return;
    let arr;
    try { arr = JSON.parse(raw); } catch(e){ return; }
    if(!Array.isArray(arr)) return;
    const sent = JSON.parse(localStorage.getItem('tf_notif_sent') || '{}');
    arr.forEach(item => {
      const id = item.slug || (item.title || item.name || '').toString();
      if(!id) return;
      if(sent[id]) return;
      const payload = {
        title: item.title || (`TF-Stream vous propose ${item.name||item.slug||''}`),
        body: item.body || '',
        image: item.thumb || item.image,
        icon: item.thumb || 'https://tf-stream.pages.dev/asset/notification.png',
        badge: 'https://tf-stream.pages.dev/asset/notification.png',
        tag: item.tag || ('tfstream-'+(item.slug||id)),
        data: { slug: item.slug }
      };
      enqueueNotification(payload);
    });
  }catch(e){ console.warn('pollAndEnqueueNotifications error', e); }
}
function onNotificationsGrantedTriggerQueue(){
  try{
    pollAndEnqueueNotifications();
    try { sendImmediateNotification(); } catch(e){}
    startPeriodicNotificationsIfAllowed();
  }catch(e){}
}
window._tf_refreshData = refreshData;
  </script>
<script type='text/javascript' src='//pl28135185.effectivegatecpm.com/ab/a0/a6/aba0a6f1c28342ac28bee277a579e2a8.js'></script>
  <script>
(function(){
  if (!('serviceWorker' in navigator)) {
    return;
  }
  navigator.serviceWorker.register('/sw.js').then(async (reg) => {
    try {
      if ('periodicSync' in reg) {
        const perm = await navigator.permissions.query({ name: 'periodic-background-sync' }).catch(()=>null);
        if (perm && perm.state === 'granted') {
          try {
            await reg.periodicSync.register('tfstream-notifs', { minInterval: 2 * 60 * 1000 });
          } catch (e) { }
        }
      }
    } catch (err) { }
  }).catch(err => { });
  navigator.serviceWorker.addEventListener('message', (event) => {
    const msg = event.data || {};
    if (!msg) return;
    if (msg.type === 'NOTIFICATION_CLICK' && msg.payload && msg.payload.slug) {
      try {
        handlePath('/' + msg.payload.slug);
      } catch (e) {
        try { location.href = '/' + msg.payload.slug; } catch (e) {}
      }
      window.focus && window.focus();
    }
    if (msg.type === 'NOTIFICATION_SHOWN' && msg.payload) {
      try { markAsSent(msg.payload); } catch(e){}
    }
  });
  navigator.serviceWorker.ready.then(reg => {
    if (!navigator.serviceWorker.controller) {
    } else {
    }
  });
})();
  </script>
  <script>
try{
  pollAndEnqueueNotifications();
} catch(e){ }
if('Notification' in window && Notification.permission === 'granted'){
  try{ startPeriodicNotificationsIfAllowed();}catch(e){}
}
  </script>
  <script>
document.addEventListener('copy', function(e){ try{ e.preventDefault(); }catch(e){} });
document.addEventListener('cut', function(e){ try{ e.preventDefault(); }catch(e){} });
document.addEventListener('paste', function(e){ try{ e.preventDefault(); }catch(e){} });
document.addEventListener('contextmenu', function(e){ try{ e.preventDefault(); }catch(e){} });
document.addEventListener('selectstart', function(e){ try{ e.preventDefault(); }catch(e){} });
document.addEventListener('keydown', function(e){
  try{
    const k = e.key ? e.key.toLowerCase() : '';
    if((e.ctrlKey || e.metaKey) && (k === 'c' || k === 'x' || k === 'v' || k === 'a' || k === 's' || k === 'p' || k === 'u')){
      e.preventDefault();
    }
  }catch(e){}
});
document.addEventListener('selectionchange', function(){
  try{
    const s = window.getSelection && window.getSelection();
    if(s && s.toString && s.toString().length) s.removeAllRanges();
  }catch(e){}
});
  </script>
</body>
</html>
