<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#000000" />
  <title>TF-Stream</title>
  <link rel="manifest" href="/manifest.json?v=2">
  <link rel="icon" type="image/jpeg" href="https://pub-46b5efc7a2f74e6797b554c867465fc0.r2.dev/1761363481529-ixgmht.jpg" />
  <link rel="apple-touch-icon" href="https://pub-46b5efc7a2f74e6797b554c867465fc0.r2.dev/1761363481529-ixgmht.jpg" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --thumb-w: clamp(90px, 14vw, 160px);
      --thumb-aspect: calc(9/16);
      --thumb-h: calc(var(--thumb-w) * var(--thumb-aspect));
      --thumb-radius: 10px;
      --card-gap: 15px;
      --bottom-space: 72px;
    }
    html, body { overscroll-behavior: none; touch-action: pan-y; height:100%; }
    body { margin:0; background:#000; color:#fff; font-family:'Roboto',sans-serif; overflow:hidden; padding-bottom:60px; }
    .header{padding:20px;text-align:center;position:sticky;top:0;backdrop-filter:blur(10px);background:rgba(0,0,0,0.7);z-index:10;}
    .logo{font-size:28px;font-weight:bold;background:linear-gradient(90deg,#fff,#000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter:blur(0.5px);}
    .filter-bar{display:flex;justify-content:center;gap:10px;margin:10px 0;flex-wrap:wrap;}
    .filter-btn{background:#222;color:#fff;border:none;padding:6px 14px;border-radius:30px;cursor:pointer;}
    .filter-btn.active{background:#444;}
    .search-container{display:flex;justify-content:center;padding:10px 20px;}
    .search-box{width:100%;max-width:500px;background:#1c1c1e;border:none;padding:12px 20px;border-radius:15px;color:#fff;font-size:16px;box-shadow:inset 0 0 5px #000;outline:none;}
    .content-area { padding:0; box-sizing:border-box; height: calc(100vh - 60px); }
    .video-list{
      display:flex;flex-wrap:wrap;gap:var(--card-gap);padding:20px;
      padding-bottom: calc(var(--bottom-space) + 8px);
      justify-content:center;min-height:200px;
      max-height: calc(100vh - 140px); overflow-y:auto; -webkit-overflow-scrolling:touch;
      box-sizing:border-box;
    }
    .video-list::after{ content:""; display:block; height:var(--bottom-space); width:100%; }
    .video-card{position:relative;width:var(--thumb-w);background:#111;border-radius:8px;overflow:visible;cursor:pointer;transition:transform .18s;display:flex;flex-direction:column;align-items:stretch;}
    .video-card:hover{transform:scale(1.03);}
    .thumb-wrap{width:100%;height:var(--thumb-h);overflow:hidden;border-radius:var(--thumb-radius);background:#111;display:block;}
    .thumb-wrap img{width:100%;height:100%;object-fit:cover;object-position:center;display:block;transform-origin:center center;}
    .card-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45);opacity:0;display:flex;align-items:center;justify-content:center;transition:opacity .25s;border-radius:8px;}
    .video-card:hover .card-overlay{opacity:1;}
    .play-icon{font-size:40px;color:#fff;}
    .info{padding:6px;text-align:center;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .nav-bar{position:fixed;bottom:0;width:100%;background:#111;display:flex;justify-content:space-around;padding:10px 0;z-index:20;border-top:1px solid #333;}
    .nav-btn{background:none;border:none;color:#aaa;font-size:14px;text-align:center;flex:1;cursor:pointer;}
    .nav-btn.active{color:#fff;font-weight:bold;}
    #explorerView{ padding:20px; padding-bottom: calc(var(--bottom-space) + 8px); max-height: calc(100vh - 140px); overflow-y:auto;display:none;background:#000;-webkit-overflow-scrolling:touch;min-height:200px; box-sizing:border-box; }
    #explorerView::after{ content:""; display:block; height:var(--bottom-space); width:100%; }
    .post-card{background:#111;border-radius:15px;padding:15px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.7);}   
    .post-name{font-weight:700;font-size:17px;margin-bottom:8px;color:#fff;}
    .post-text{font-size:15px;color:#ddd;margin-bottom:10px;white-space:pre-wrap;}
    .social-section{margin-top:10px;padding-top:10px;border-top:1px solid #333;display:flex;justify-content:center;gap:15px;}
    .social-section img{width:40px;height:40px;}
    .overlay-fond{position:fixed;inset:0;background:rgba(0,0,0,0.8);backdrop-filter:blur(20px);display:none;justify-content:center;align-items:flex-start;padding:20px;overflow-y:auto;z-index:999;}
    .modal-container{background:#111;border-radius:10px;padding:20px;max-width:700px;width:100%;box-shadow:0 4px 20px rgba(0,0,0,0.8);position:relative;}
    .modal-container button{background:#444;color:#fff;border:none;padding:8px 14px;border-radius:6px;cursor:pointer;}
    .thumbnail{width:auto;max-width:100%;height:auto;max-height:70vh;object-fit:contain;border-radius:6px;margin-bottom:12px;}
    .modal-title{font-size:24px;font-weight:700;margin-bottom:8px;}
    .modal-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;}
    .season-list{position:absolute;top:60px;right:20px;background:#111;border-radius:6px;overflow:hidden;box-shadow:0 2px 10px rgba(0,0,0,0.7);display:none;z-index:1001;}
    .season-list button{width:100%;padding:10px;text-align:left;background:#222;color:#fff;border:none;border-bottom:1px solid #333;cursor:pointer;}
    .modal-info{background:#111;border-radius:6px;padding:12px;font-size:14px;color:#ddd;margin-bottom:12px;display:none;}
    .modal-episodes{display:grid;grid-template-columns:1fr;gap:10px;}
    .episode-item{background:rgba(0,0,0,0.6);padding:12px;border-radius:8px;cursor:pointer;transition:transform .2s;}
    .episode-item:hover{transform:scale(1.02);}
    .episode-item.active { background: rgba(200,200,200,0.3); }
    .episode-item.visited { background: rgba(50,50,50,0.4); color: #aaa; font-weight: normal; }
    .ad-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.9);display:none;justify-content:center;align-items:center;z-index:1000;}
    .ad-container{background:#111;padding:20px;border-radius:10px;text-align:center;}
    .ad-container button{background:#444;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;}
    #splash { position: fixed; inset:0; background:#000; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:9999; animation: splashPop 1.7s forwards; pointer-events:auto; }
    .splash-logo { font-size:3rem; font-weight:bold;background:linear-gradient(90deg,#fff,#000);-webkit-background-clip:text;-webkit-text-fill-color:transparent;filter: blur(0.5px); margin:0; animation:logoPop 1.7s ease-out forwards; }
    .splash-version { margin-top:0.5rem; color:#aaa; font-size:1rem; animation:logoPop 1.7s ease-out forwards; }
    @keyframes splashPop { 0%{opacity:1} 80%{opacity:1} 100%{opacity:0} }
    @keyframes logoPop { 0%{transform:scale(1);opacity:1} 50%{transform:scale(1.2)} 80%{transform:scale(1.1)} 100%{opacity:0;transform:scale(1.1)} }
    .media-container { width:100%; height:auto; overflow:visible; padding:6px 0; background:transparent; display:flex; justify-content:center; align-items:center; }
    .media-container img, .media-container video { width:auto; height:auto; max-width:100%; max-height:80vh; object-fit:contain; display:block; margin:0 auto; border-radius:8px; }
    .post-card .media-container { padding:6px 0; }
    .post-card .media-container img { width:auto; height:auto; max-width:100%; max-height:360px; object-fit:contain; display:block; margin:0 auto; }
    .post-card .media-container video { width:auto; height:auto; max-width:100%; max-height:480px; object-fit:contain; display:block; border-radius:8px; }
    .explorer-video { width:auto; max-width:100%; height:auto; max-height:480px; object-fit:contain; border-radius:8px; display:block; margin:0 auto; }
    .notif-request { position:fixed;left:50%;transform:translateX(-50%);bottom:76px;background:#111;padding:12px 14px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.7);z-index:10001;display:none;align-items:center;gap:8px; }
    .notif-request button{background:#222;border:1px solid #333;padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer;}
    .notif-request small{display:block;color:#bbb;font-size:13px;margin-top:6px;text-align:center;}
    * { -webkit-user-select: none !important; -moz-user-select: none !important; -ms-user-select: none !important; user-select: none !important; }
    input, textarea, select, .search-box { -webkit-user-select: text !important; -moz-user-select: text !important; -ms-user-select: text !important; user-select: text !important; }
    body, html { -webkit-touch-callout: none; }
    ::-webkit-scrollbar { display: none; }
    html { scrollbar-width: none; -ms-overflow-style: none; }
  </style>
</head>
<body>
  <div id="splash"><h1 class="splash-logo">TF-Stream</h1><p class="splash-version">D'H7 | Tergene</p></div>
  <div id="fondOverlay" class="overlay-fond" aria-hidden="true"></div>

  <div class="header" id="mainHeader">
    <div class="logo" id="appLogo">TF-Stream</div>

    <div class="filter-bar">
      <button class="filter-btn active" onclick="filterCategory('Tout',event)">Tout</button>
      <button class="filter-btn" onclick="filterCategory('Film',event)">Film</button>
      <button class="filter-btn" onclick="filterCategory('Série',event)">Série</button>
      <button class="filter-btn" onclick="filterCategory('Anime',event)">Anime</button>
    </div>

    <div class="search-container">
      <input id="searchBox" class="search-box" type="text" placeholder="Rechèch..." autocomplete="off">
    </div>
  </div>

  <div class="content-area">
    <div class="video-list" id="videoList"></div>
    <div id="explorerView"></div>
  </div>

  <div class="nav-bar">
    <button class="nav-btn active" onclick="navigateTo('Accueil',event)">Accueil</button>
    <button class="nav-btn" onclick="navigateTo('Explorer',event)">Explorer</button>
  </div>

  <div id="adOverlay" class="ad-overlay">
    <div class="ad-container">
      <p>Publicité</p>
      <button id="adLinkBtn">En savoir plus</button>
      <button onclick="closeAd()">Fermer</button>
    </div>
  </div>

  <div id="notifRequest" class="notif-request" role="dialog" aria-hidden="true">
    <div style="display:flex;gap:8px;align-items:center;">
      <div style="font-weight:700">Activer notifications</div>
      <button onclick="requestNotificationPermission('android')">Android</button>
      <button onclick="requestNotificationPermission('pc')">PC</button>
      <button onclick="requestNotificationPermission('iphone')">iPhone</button>
      <button onclick="hideNotifRequest()">Plus tard</button>
    </div>
    <small id="notifRequestHint">Recevez des nouveautés (Film, Série, Anime). Pas de notifications pour les postes.</small>
  </div>

<script>
  const IMAGE_TIMEOUT = 7000;
  const MAX_SPLASH_WAIT = 7000;
  const NO_THUMB_SVG = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="512" height="288" viewBox="0 0 512 288"><rect width="100%" height="100%" fill="#222"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#ddd" font-family="Arial, Helvetica, sans-serif" font-size="28">No Thumb</text></svg>');

  function slugify(text){ return String(text||'').toLowerCase().normalize('NFD').replace(/[̀-ͯ]/g,'').replace(/[^\w\s-]/g,'').trim().replace(/\s+/g,'-'); }
  function shuffleArray(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

  const socialLinks={whatsapp:"https://whatsapp.com/channel/0029VbB3DwvLtOjCUY4RaK39",instagram:"https://www.instagram.com/tfstream7?igsh=ZmE2OHB3MjU5NWY3&utm_source=ig_contact_invite",facebook:"https://www.facebook.com/profile.php?id=61582243315831",youtube:"https://www.youtube.com/@TFStream7",gmail:"mailto:tfstream7@gmail"};
  const adUrl="https://pantherinvincible.com/yqsqxk5wu0?key=60a527bb6c037e8d6ce7469648b76dcb";

  const videoListEl=document.getElementById('videoList');
  const explorerEl=document.getElementById('explorerView');
  const overlay=document.getElementById('fondOverlay');
  const searchBox=document.getElementById('searchBox');

  window.allData=[];
  window.slugMap={};
  window._viewScroll = { accueil: 0, explorer: 0 };
  window._shuffledOnce = false;

  function readState(key){try{return JSON.parse(localStorage.getItem(key)||'{}');}catch(e){return {};} }
  function writeState(key,obj){try{localStorage.setItem(key,JSON.stringify(obj));}catch(e){} }

  function openDB(){return new Promise((resolve,reject)=>{const req=indexedDB.open('tfStream',1);req.onupgradeneeded=()=>{const db=req.result;if(!db.objectStoreNames.contains('uploads')){db.createObjectStore('uploads',{keyPath:'id',autoIncrement:true});}};req.onsuccess=()=>resolve(req.result);req.onerror=()=>reject(req.error);});}
  function getAllUploads(){return openDB().then(db=>new Promise((res,rej)=>{const tx=db.transaction('uploads','readonly');const store=tx.objectStore('uploads');const req=store.getAll();req.onsuccess=()=>{db.close();res(req.result||[]);};req.onerror=()=>{db.close();rej(req.error);};}));}

  // preload thumbnails during splash for smooth UI
  async function preloadAllDuringSplash(){
    try{
      const timeoutStart = Date.now();
      let files = [];
      try{ const r = await fetch('index.json',{cache:'no-cache'}); if(r.ok) files = await r.json(); }catch(e){}
      const jsons = await Promise.all((files||[]).map(f=>fetch(f).then(res=>res.ok?res.json():null).catch(()=>null)));
      const thumbs = new Set();
      jsons.forEach(d=>{ if(!d) return; const list = Array.isArray(d)?d:[d]; list.forEach(it=>{ if(!it) return; const c=(it.Catégorie||it.category||'').toString().toLowerCase(); if(c === 'poste') return; if(it['Url Thumb']) thumbs.add(new URL(it['Url Thumb'], location.origin).href); if(it.thumb) thumbs.add(new URL(it.thumb, location.origin).href); if(it.Saisons && Array.isArray(it.Saisons)){ it.Saisons.forEach(s=>{ if(s && Array.isArray(s.episodes)){ s.episodes.forEach(ep=>{ if(ep && ep.thumb) thumbs.add(new URL(ep.thumb, location.origin).href); if(ep && ep.thumbnail) thumbs.add(new URL(ep.thumbnail, location.origin).href); }); } }); } }); });
      const loads = Array.from(thumbs).map(url => loadImageWithTimeout(url, IMAGE_TIMEOUT).catch(()=>NO_THUMB_SVG));
      await Promise.all([...loads]);
      const elapsed = Date.now() - timeoutStart;
      const remain = Math.max(0, Math.min(MAX_SPLASH_WAIT - elapsed, 1200));
      await new Promise(res => setTimeout(res, remain));
    }catch(e){}
  }

  function loadImageWithTimeout(url, timeout){
    return new Promise((resolve,reject)=>{
      if(!url) return reject(new Error('no url'));
      const img = new Image();
      let settled = false;
      const timer = setTimeout(()=>{ if(!settled){ settled=true; img.src = ''; resolve(NO_THUMB_SVG); } }, timeout);
      img.onload = ()=>{ if(settled) return; settled=true; clearTimeout(timer); resolve(url); };
      img.onerror = ()=>{ if(settled) return; settled=true; clearTimeout(timer); resolve(NO_THUMB_SVG); };
      img.src = url;
    });
  }

  function setImageSrcWithTimeout(imgEl, url, timeout){
    if(!imgEl) return;
    if(!url){ imgEl.dataset.src = NO_THUMB_SVG; imgEl.src = NO_THUMB_SVG; return; }
    if(imgEl.dataset.src === url) return;
    imgEl.dataset.src = url;
    let loaded = false;
    const timed = setTimeout(()=>{ if(!loaded){ imgEl.src = NO_THUMB_SVG; imgEl.dataset.src = NO_THUMB_SVG; } }, timeout);
    const onload = ()=>{ loaded = true; clearTimeout(timed); imgEl.removeEventListener('load', onload); imgEl.removeEventListener('error', onerror); };
    const onerror = ()=>{ loaded = true; clearTimeout(timed); imgEl.src = NO_THUMB_SVG; imgEl.dataset.src = NO_THUMB_SVG; imgEl.removeEventListener('load', onload); imgEl.removeEventListener('error', onerror); };
    imgEl.addEventListener('load', onload);
    imgEl.addEventListener('error', onerror);
    imgEl.src = url;
  }

  document.addEventListener('copy',(e)=>{e.preventDefault();});
  document.addEventListener('contextmenu',(e)=>{e.preventDefault();});

  overlay.addEventListener('click',(e)=>{if(e.target===overlay){ navigatePath('/Accueil'); closeModal(); }});

  // initial data load
  (function loadDataInitial(){
    fetch('index.json').then(r=>{if(!r.ok)throw new Error('index.json not ok');return r.json();})
    .then(files=>{ return Promise.all(files.map(f=>fetch(f).then(res=>res.ok?res.json():null).catch(()=>null))); })
    .then(jsons=>{
      jsons.forEach(d=>{ if(!d) return; if(Array.isArray(d)) window.allData.push(...d); else window.allData.push(d); });
      return getAllUploads().catch(()=>[]);
    })
    .then(uploads=>{
      (uploads||[]).forEach(u=>{
        const item={Titre:u.title||('Upload '+(u.id||'')),Name:u.title||('Upload '+(u.id||'')),Catégorie:'poste',Url:u.url||'', 'Url Thumb':u.thumb||'', Description:u.description||'', uploaded:true, __uploadedId:u.id};
        window.allData.unshift(item);
      });
      if(window.allData.length===0 && window.sampleData) window.allData = window.sampleData.slice();
      if(!window._shuffledOnce){ shuffleArray(window.allData); window._shuffledOnce = true; }
      prepareSlugMap();
      if(location.pathname==='/'||location.pathname===''){history.replaceState({},'', '/Accueil');}
      handlePath(location.pathname);
    })
    .catch(()=>{});
  })();

  function prepareSlugMap(){
    window.slugMap={};
    window.allData.forEach((it,i)=>{ const title=it.Titre||it.Name||it.Title||it['Nom']||('item-'+i); const base=slugify(title); let slug=base||('item-'+i); let k=1; while(window.slugMap[slug]){ slug=base+'-'+k; k++; } window.slugMap[slug]={item:it,index:i,slug:slug}; it.__slug=slug; });
  }

  async function preloadAndShowSplash(){
    try{
      await preloadAllDuringSplash();
    }catch(e){}
  }

  // rendering
  let __displayVideosTimer = null;
  function displayVideos(videos){
    if(__displayVideosTimer) clearTimeout(__displayVideosTimer);
    __displayVideosTimer = setTimeout(()=>{ __displayVideosTimer = null; _renderDisplayVideos(videos); }, 80);
  }

  function _renderDisplayVideos(videos){
    const prevScroll = videoListEl.scrollTop || 0;
    const activeBtn=document.querySelector('.filter-btn.active');
    const cat=activeBtn?activeBtn.textContent.toLowerCase():'tout';
    let visible=videos.filter(v=>{
      const c=(v.Catégorie||v.category||'').toLowerCase();
      if(c==='poste') return false;
      if(cat==='tout') return true;
      if(cat==='film'&&c==='film') return true;
      if(cat==='série'&&(c==='série'||c==='serie')) return true;
      if(cat==='anime'&&(c==='anime'||c==='animé')) return true;
      return false;
    });
    const frag = document.createDocumentFragment();
    if(visible.length===0){ videoListEl.innerHTML='<div style="color:#888;width:100%;text-align:center;padding:60px 0">Aucun contenu trouvé</div>'; return; }
    visible.forEach((v)=>{
      const card=document.createElement('div'); card.className='video-card';
      const thumbUrl = v['Url Thumb'] || v.thumb || NO_THUMB_SVG;
      card.innerHTML=`<div class="thumb-wrap"><img loading="lazy" alt=""></div><div class="card-overlay"><span class="play-icon">▶</span></div><div class="info">${escapeHtml(v.Titre||v.Name||v.Texte||'Sans titre')}</div>`;
      const img = card.querySelector('img');
      setImageSrcWithTimeout(img, thumbUrl, IMAGE_TIMEOUT);
      card.addEventListener('click',()=>{ showPostModal(v,window.allData.indexOf(v)); });
      frag.appendChild(card);
    });
    videoListEl.innerHTML='';
    videoListEl.appendChild(frag);
    if(window._viewScroll && typeof window._viewScroll.accueil === 'number'){ videoListEl.scrollTop = window._viewScroll.accueil; } else { videoListEl.scrollTop = prevScroll; }
  }

  function displayExplorer(){
    explorerEl.innerHTML='';
    let posts=window.allData.filter(p=>(p.Catégorie||p.category||'').toString().toLowerCase()==='poste');
    if(posts.length===0){ explorerEl.innerHTML='<div style="color:#888;width:100%;text-align:center;padding:60px 0">Aucun poste</div>'; return; }
    posts.forEach(post=>{
      const thumbUrl=post['Url Thumb']||NO_THUMB_SVG;
      const videoUrl=post.Previously||post['Previously ']||post.video||post.Url||'';
      const card=document.createElement('div'); card.className='post-card';
      card.innerHTML=`<div class="media-container"><img class="thumb" alt=""></div><div class="post-name">${escapeHtml(post.Name||post.Titre||'')}</div><div class="post-text">${escapeHtml(post.Description||post.Bio||'')}</div>`;
      explorerEl.appendChild(card);
      const thumb=card.querySelector('.thumb');
      setImageSrcWithTimeout(thumb, thumbUrl, IMAGE_TIMEOUT);
      card.addEventListener('click',(e)=>{ e.stopPropagation(); });
      if(thumb){
        thumb.style.cursor=videoUrl?'pointer':'default';
        thumb.addEventListener('click',(e)=>{ e.stopPropagation(); if(!videoUrl) return; const media=card.querySelector('.media-container'); if(media.querySelector('video')) return; const v=document.createElement('video'); v.src=videoUrl; v.controls=true; v.autoplay=false; v.playsInline=true; v.muted=false; v.className='explorer-video'; media.innerHTML=''; media.appendChild(v); v.focus&&v.focus(); },{passive:true});
      }
    });
    if(window._viewScroll && typeof window._viewScroll.explorer === 'number'){ explorerEl.scrollTop = window._viewScroll.explorer; }
    displaySocialLinks();
  }

  function displaySocialLinks(){ const existing=explorerEl.querySelector('.social-section'); if(existing) existing.remove(); const s=document.createElement('div'); s.className='social-section'; s.innerHTML=`<a href="${socialLinks.facebook}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=118467&format=png&color=ffffff"/></a><a href="${socialLinks.gmail}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=Y2GfpkgYNp42&format=png&color=ffffff"/></a><a href="${socialLinks.whatsapp}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=16733&format=png&color=ffffff"/></a><a href="${socialLinks.instagram}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=32309&format=png&color=ffffff"/></a><a href="${socialLinks.youtube}" target="_blank" rel="noreferrer"><img src="https://img.icons8.com/?size=100&id=37326&format=png&color=ffffff"/></a>`; explorerEl.appendChild(s); }

  function navigatePath(path){ path=path||'/Accueil'; if(location.pathname!==path){ history.pushState({},'',path); } else { handlePath(path); } }

  function filterCategory(_,e){ document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active')); e.target.classList.add('active'); displayVideos(window.allData); navigatePath('/Accueil'); }

  function filterSearch(val){ const results=window.allData.filter(i=>(i.Titre||i.Name||i.Texte||'').toLowerCase().includes(val.toLowerCase())); displayVideos(results); navigatePath('/search'); }

  function saveCurrentScroll(){
    if(videoListEl.style.display !== 'none'){ window._viewScroll.accueil = videoListEl.scrollTop || 0; }
    if(explorerEl.style.display !== 'none'){ window._viewScroll.explorer = explorerEl.scrollTop || 0; }
  }

  function navigateTo(sec,e){
    saveCurrentScroll();
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    if(e&&e.target) e.target.classList.add('active');
    videoListEl.style.display='none'; explorerEl.style.display='none'; document.querySelector('.filter-bar').style.display='none'; document.querySelector('.search-container').style.display='none';
    if(sec==='Accueil'){ displayVideos(window.allData); videoListEl.style.display='flex'; document.querySelector('.filter-bar').style.display='flex'; document.querySelector('.search-container').style.display='flex'; navigatePath('/Accueil'); }
    else { displayExplorer(); explorerEl.style.display='block'; document.querySelector('.search-container').style.display='flex'; navigatePath('/Explorer'); }
  }

  // Modal & playback helpers
  function lockBodyScroll(){
    document.documentElement.style.top = `-${window.scrollY||0}px`;
    document.documentElement.style.position = 'fixed';
    document.documentElement.style.width = '100%';
  }
  function unlockBodyScroll(){
    document.documentElement.style.position = '';
    document.documentElement.style.top = '';
    window.scrollTo(0, 0);
  }

  // Improved showPostModal:
  // - Normalizes seasons/episodes fields
  // - Shows Description/Bio/Info using season fallback -> global fallback
  // - Does not automatically open popup ad (previously window.open). Ad overlay kept separate.
  function showPostModal(post,postIndex,opts={push:true}){
    const slug=post.__slug||slugify((post.Titre||post.Name||('item-'+postIndex)));
    overlay.innerHTML=`<div class="modal-container" role="dialog" aria-modal="true"><button id="modalBackBtn">← Retour</button><div class="media-container" id="mediaWrap"><img id="modalImg" class="thumbnail" src="${post['Url Thumb']||NO_THUMB_SVG}" alt="poster"><video id="modalVideo" class="thumbnail" style="display:none;" muted controls playsinline controlsList="nodownload"></video></div><div id="modalTitle" class="modal-title"></div><div class="modal-controls"><button id="infoBtn">Voir plus…</button><button id="seasonBtn">Saison 1</button></div><div id="seasonList" class="season-list"></div><div id="modalInfo" class="modal-info"></div><div id="episodeList" class="modal-episodes"></div></div>`;
    overlay.style.display='flex'; overlay.setAttribute('aria-hidden','false'); overlay.style.overflow='hidden';
    hideBackgroundForModal();
    lockBodyScroll();

    const modalImg=document.getElementById('modalImg'), modalVideo=document.getElementById('modalVideo'), titleEl=document.getElementById('modalTitle'),
          infoBtn=document.getElementById('infoBtn'), seasonBtn=document.getElementById('seasonBtn'), seasonList=document.getElementById('seasonList'),
          infoEl=document.getElementById('modalInfo'), epList=document.getElementById('episodeList');

    titleEl.textContent=post.Titre||post.Name||'';

    // Normalize seasons/episodes:
    let saisons = post.Saisons || post.Seasons || post.saisons || post.seasons || [];
    // If top-level episodes exist, put them into a single season
    if((!saisons || saisons.length === 0)) {
      const topEps = post.Episodes || post.episodes || post['Épisodes'] || post['episodes'] || [];
      if(Array.isArray(topEps) && topEps.length) saisons = [{ episodes: topEps }];
    }
    saisons = (saisons || []).map(s => {
      const eps = s.episodes || s.Episodes || s['episodes'] || s['Episodes'] || s['Épisodes'] || s['episodes_list'] || [];
      return Object.assign({}, s, { episodes: Array.isArray(eps) ? eps : [] });
    });

    const globalDescription = post.Description || post.description || post.Summary || post.synopsis || '';
    const globalBio         = post.Bio || post.bio || '';
    const globalInfo        = post.Info || post.info || '';

    const storageKey=`post-${slug}-state`;
    const saved=readState(storageKey)||{};
    let playbackTimes=saved.playbackTimes||{};
    let visited=saved.visited||{};
    let currentSeason=0,selectedEpEl=null;

    function saveState(){ const last=(modalVideo.style.display!=='none'&&modalVideo.src)?modalVideo.src:(saved.lastVideoUrl||''); writeState(storageKey,{lastVideoUrl:last,playbackTimes,visited}); }

    function renderInfo(){ const s=saisons[currentSeason]||{}; const desc = s.description || s.Description || s.synopsis || s.Synopsis || globalDescription; const bio = s.bio || s.Bio || globalBio; const info = s.info || s.Info || globalInfo; infoEl.innerHTML=`<strong>Description:</strong> ${escapeHtml(desc||'')}<br><strong>Bio:</strong> ${escapeHtml(bio||'')}<br><strong>Info:</strong> ${escapeHtml(info||'')}`; infoEl.style.display='block'; }
    infoBtn.onclick=()=>infoEl.style.display=infoEl.style.display==='block'?'none':'block';

    // seasons list
    seasonList.innerHTML='';
    if(saisons.length > 1){
      saisons.forEach((s,i)=>{ const b=document.createElement('button'); b.textContent=`Saison ${i+1}`; b.onclick=()=>{ currentSeason=i; seasonBtn.textContent=`Saison ${i+1}`; renderInfo(); renderEpisodes(); seasonList.style.display='none'; }; seasonList.appendChild(b); });
      seasonBtn.style.display='inline-block';
      seasonBtn.onclick=()=>seasonList.style.display=seasonList.style.display==='block'?'none':'block';
      seasonBtn.textContent = `Saison ${currentSeason+1}`;
    } else {
      seasonBtn.style.display='none';
    }

    async function tryEnterFullscreenAndLockOrientation(el){
      try{
        if(el.requestFullscreen) await el.requestFullscreen({navigationUI:'hide'});
        if(screen.orientation && screen.orientation.lock){ try{ await screen.orientation.lock('landscape'); }catch(e){} }
      }catch(e){}
    }

    function activateVideo(src,episodeThumb){
      // removed auto-popup to external ad to avoid popup blocking / UX issues.
      if(modalVideo&&modalVideo.src){ playbackTimes[modalVideo.src]=Math.max(0,modalVideo.currentTime||0); }
      if(episodeThumb) modalImg.src=episodeThumb;
      modalImg.style.display='none'; modalVideo.style.display='block';
      try{ modalVideo.pause(); }catch(e){}
      modalVideo.src=src; modalVideo.load(); modalVideo.muted=false; modalVideo.playsInline = true;
      tryEnterFullscreenAndLockOrientation(modalVideo).catch(()=>{});
      const restoreTime=()=>{ try{ if(playbackTimes[src]) modalVideo.currentTime=playbackTimes[src]; else modalVideo.currentTime=0; }catch(e){} modalVideo.removeEventListener('loadedmetadata',restoreTime); };
      modalVideo.addEventListener('loadedmetadata',restoreTime);
      const p=modalVideo.play(); if(p&&p.catch)p.catch(()=>{});
      modalVideo.addEventListener('play', ()=>{ requestWakeLock(); }, {once:true});
      modalVideo.addEventListener('pause', ()=>{ releaseWakeLock(); });
    }

    function activateImage(poster){
      if(modalVideo&&modalVideo.src){ playbackTimes[modalVideo.src]=Math.max(0,modalVideo.currentTime||0); }
      try{ modalVideo.pause(); }catch(e){}
      modalVideo.removeAttribute('src'); modalVideo.load();
      modalVideo.style.display='none'; modalImg.style.display='block';
      if(poster) setImageSrcWithTimeout(modalImg, poster, IMAGE_TIMEOUT);
      saveState();
    }

    function renderEpisodes(){
      epList.innerHTML='';
      const eps=(saisons[currentSeason]&&saisons[currentSeason].episodes)||[];
      if(!eps || eps.length === 0){
        epList.innerHTML = `<div style="color:#999;padding:8px;">Aucun épisode disponible.</div>`;
        epList.style.display = 'block';
        return;
      }
      eps.forEach((ep,i)=>{
        const d=document.createElement('div'); d.className='episode-item';
        const epDesc = ep.description || ep.Description || ep.title || ep.Titre || '';
        d.innerHTML=`<strong>Episode ${i+1}</strong><div>${escapeHtml(epDesc||'')}</div>`;
        const visKey=ep.video||ep.url||ep.stream||('ep-'+i);
        if(visited[visKey]) d.classList.add('visited');
        d.onclick=()=>{
          if(selectedEpEl) selectedEpEl.classList.remove('active');
          d.classList.add('active'); selectedEpEl=d;
          const newSrc=ep.video||ep.url||ep.stream||'';
          if(!newSrc) return;
          activateVideo(newSrc, ep.thumb||ep.thumbnail||post['Url Thumb']||'');
          const onTime=()=>{
            try{
              if(modalVideo.currentTime>7){ d.classList.add('visited'); visited[visKey]=true; modalVideo.removeEventListener('timeupdate',onTime); saveState(); }
            }catch(e){}
          };
          modalVideo.addEventListener('timeupdate', onTime);
          saveState();
        };
        epList.appendChild(d);
      });
      epList.style.display = 'block';
    }

    renderInfo(); renderEpisodes();

    if(saved&&saved.lastVideoUrl){
      let found=false;
      for(let si=0; si<(saisons.length||0)&&!found; si++){
        const eps=(saisons[si]&&saisons[si].episodes)||[];
        for(let ei=0; ei<eps.length; ei++){
          if(eps[ei] && (eps[ei].video===saved.lastVideoUrl || eps[ei].url===saved.lastVideoUrl)){
            currentSeason=si; seasonBtn.textContent=`Saison ${si+1}`; renderInfo(); renderEpisodes();
            const el=epList.children[ei];
            if(el){ el.click(); found=true; break; }
          }
        }
      }
      if(!found){
        const url=saved.lastVideoUrl;
        if(url && (url.match(/\.(mp4|webm|m3u8|mpd)(\?|$)/i) || url.startsWith('blob:') || url.startsWith('http'))){
          activateVideo(url, post['Url Thumb']||'');
          const restoreTime2=()=>{ try{ if(saved.playbackTimes && saved.playbackTimes[url]){ modalVideo.currentTime=saved.playbackTimes[url]; } else { modalVideo.currentTime=0; } }catch(e){} modalVideo.removeEventListener('loadedmetadata',restoreTime2); };
          modalVideo.addEventListener('loadedmetadata', restoreTime2);
        } else { activateImage(post['Url Thumb']||''); }
      }
    } else { modalImg.style.display='block'; modalVideo.style.display='none'; }

    if(opts.push!==false){
      const path='/' + slug;
      if(location.pathname!==path) history.pushState({},'',path);
    } else {
      history.replaceState({},'', '/'+slug);
    }

    document.getElementById('modalBackBtn').onclick=()=>{
      try{ modalVideo.pause(); }catch(e){}
      activateImage(post['Url Thumb']||'');
      try{ if(document.fullscreenElement) document.exitFullscreen(); if(screen.orientation && screen.orientation.unlock) screen.orientation.unlock(); }catch(e){}
      releaseWakeLock();
      unlockBodyScroll();
      restoreBackgroundAfterModal();
      navigatePath('/Accueil');
      closeModal();
    };
  }

  function closeModal(){ overlay.style.display='none'; overlay.innerHTML=''; overlay.setAttribute('aria-hidden','true'); overlay.style.overflow=''; unlockBodyScroll(); restoreBackgroundAfterModal(); }

  function handlePath(rawPath){
    const p=String(rawPath||location.pathname||'').replace(/^\/+/,''), lower=(p||'').toString().toLowerCase();
    if(!p||lower==='accueil'){
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.nav-btn')[0]?.classList.add('active');
      document.querySelector('.filter-bar').style.display='flex';
      document.querySelector('.search-container').style.display='flex';
      displayVideos(window.allData);
      videoListEl.style.display='flex';
      explorerEl.style.display='none';
      closeModal();
      return;
    }
    if(lower==='explorer'||lower==='explore'){
      document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.nav-btn')[1]?.classList.add('active');
      document.querySelector('.filter-bar').style.display='none';
      document.querySelector('.search-container').style.display='flex';
      displayExplorer();
      explorerEl.style.display='block';
      videoListEl.style.display='none';
      closeModal();
      return;
    }
    if(lower==='search'){ closeModal(); return; }
    const slug=p;
    const info=window.slugMap[slug]||window.slugMap[slug.toLowerCase()];
    if(info&&info.item){ showPostModal(info.item,info.index,{push:false}); }
    else { closeModal(); displayVideos(window.allData); videoListEl.style.display='flex'; explorerEl.style.display='none'; }
  }

  window.addEventListener('popstate',()=>handlePath(location.pathname));

  function handleServiceWorkerMessage(event){
    const msg = event && event.data ? event.data : null;
    if(!msg || !msg.type) return;
    if(msg.type === 'NOTIFICATION_CLICK'){
      const slug = msg.payload && msg.payload.slug ? msg.payload.slug : undefined;
      if(!slug){ navigatePath('/Accueil'); return; }
      const tryOpen = (attemptsLeft=1)=>{
        const info = window.slugMap && (window.slugMap[slug] || window.slugMap[slug.toLowerCase()]);
        if(info && info.item){ try { showPostModal(info.item, info.index, { push: false }); } catch(e){ navigatePath('/Accueil'); } return true; }
        if(attemptsLeft>0){ refreshData().then(()=>{ setTimeout(()=>tryOpen(attemptsLeft-1), 250); }).catch(()=>{ setTimeout(()=>tryOpen(attemptsLeft-1), 250); }); return false; }
        navigatePath('/Accueil');
        return false;
      };
      tryOpen(1);
    }
  }

  window.addEventListener('load', async ()=>{
    if('serviceWorker' in navigator){
      try{
        const reg = await navigator.serviceWorker.register('/sw.js',{scope:'/'});
        navigator.serviceWorker.addEventListener('message', handleServiceWorkerMessage);
        if(reg.active && reg.active.postMessage){ reg.active.postMessage({type:'LIST_CACHES'}); }
      }catch(e){}
    }
    const splash = document.getElementById('splash');
    const splashRemover = (function(){
      let removed=false;
      return function removeSplash(){
        if(removed) return; removed=true;
        try{ if(splash){ splash.style.pointerEvents='none'; if(splash.parentNode) splash.parentNode.removeChild(splash); } }catch(e){}
        prepareSlugMap();
        displayVideos(window.allData);
        showNotifPromptIfNeeded();
      };
    })();
    if(splash){ splash.addEventListener('animationend', ()=>{ splashRemover(); }); }
    const preloadPromise = preloadAllDuringSplash();
    const maxWait = new Promise(res=>setTimeout(res, MAX_SPLASH_WAIT));
    Promise.race([preloadPromise.then(()=>{}), maxWait]).then(()=>{ splashRemover(); });
  });

  searchBox.addEventListener('keydown',function(e){ if(e.key==='Enter'){ const val=this.value.trim(); if(val==='')return; filterSearch(val); } });
  searchBox.addEventListener('input',function(){ const v=this.value||''; if(v.startsWith('/')) return; showSearchSpinner(); clearTimeout(window.__tf_search_timeout); window.__tf_search_timeout=setTimeout(()=>{ filterSearch(v); hideSearchSpinner(); },350); });

  function showSearchSpinner(){ if(document.getElementById('tf-search-spinner'))return; const spinner=document.createElement('div'); spinner.id='tf-search-spinner'; spinner.style.cssText='position:fixed;top:16px;left:50%;transform:translateX(-50%);width:40px;height:40px;border-radius:20px;z-index:10000;display:flex;align-items:center;justify-content:center;'; spinner.innerHTML='<div style="width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.15);border-top-color:#fff;animation:tfspin 0.9s linear infinite"></div>'; document.body.appendChild(spinner); const style=document.createElement('style'); style.id='tf-search-style'; style.innerHTML='@keyframes tfspin{to{transform:rotate(360deg);}}'; document.head.appendChild(style); }
  function hideSearchSpinner(){ const s=document.getElementById('tf-search-spinner'); if(s)s.remove(); const st=document.getElementById('tf-search-style'); if(st)st.remove(); }

  try { window.location.reload = function(){}; } catch(e) {}
  window.addEventListener('keydown', function(e){ if(e.key === 'F5') { e.preventDefault(); e.stopPropagation(); return false; } if((e.ctrlKey || e.metaKey) && (e.key === 'r' || e.key === 'R')){ e.preventDefault(); e.stopPropagation(); return false; } if(e.ctrlKey && e.shiftKey && (e.key === 'R' || e.key === 'r')){ e.preventDefault(); e.stopPropagation(); return false; } if((e.ctrlKey || e.metaKey) && e.key === 'F5'){ e.preventDefault(); e.stopPropagation(); return false; } }, {capture:true});
  window.addEventListener('mousedown', function(e){ if(e.button === 1){ e.preventDefault(); e.stopPropagation(); return false; } }, {capture:true});
  window.addEventListener('beforeunload', function (e) { e.preventDefault(); e.returnValue = ''; return ''; });

  document.addEventListener('click', function(e){
    const a = e.target.closest && e.target.closest('a');
    if(a && a.getAttribute('href') && a.getAttribute('href').startsWith('#') === false){
      const href = a.getAttribute('href');
      try {
        const u = new URL(href, location.href);
        if(u.origin === location.origin){
          e.preventDefault();
          history.pushState({}, '', u.pathname + u.search + u.hash);
          handlePath(u.pathname.replace(/^\/+/,'')); 
        }
      } catch(e){}
    }
  }, {capture:true});

  async function refreshData(){
    try{
      const r = await fetch('index.json',{cache:'no-cache'});
      if(!r.ok) return;
      const files = await r.json();
      const jsons = await Promise.all(files.map(f=>fetch(f).then(res=>res.ok?res.json():null).catch(()=>null)));
      const newItems = [];
      jsons.forEach(d=>{ if(!d) return; if(Array.isArray(d)) d.forEach(it=>newItems.push(it)); else newItems.push(d); });
      const uploads = await getAllUploads().catch(()=>[]);
      uploads.forEach(u=>{ newItems.unshift({Titre:u.title||('Upload '+(u.id||'')),Name:u.title||('Upload '+(u.id||'')),Catégorie:'poste',Url:u.url||'', 'Url Thumb':u.thumb||'', Description:u.description||'', uploaded:true, __uploadedId:u.id}); });
      window.allData = newItems.slice();
      shuffleArray(window.allData);
      prepareSlugMap();
      displayVideos(window.allData);
    }catch(e){}
  }

  function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

  // small utilities used by modal locking/restoring
  const bgElementsSelectors = ['.header', '.content-area', '.nav-bar'];
  const bgElements = bgElementsSelectors.map(s=>document.querySelector(s)).filter(Boolean);

  function hideBackgroundForModal(){
    bgElements.forEach(el=>{
      el.setAttribute('aria-hidden','true');
      try{ el.inert = true; }catch(e){}
      el.style.pointerEvents = 'none';
      el.style.visibility = 'hidden';
      el.style.userSelect = 'none';
    });
    videoListEl.style.overflow = 'hidden';
    explorerEl.style.overflow = 'hidden';
  }
  function restoreBackgroundAfterModal(){
    bgElements.forEach(el=>{
      el.removeAttribute('aria-hidden');
      try{ el.inert = false; }catch(e){}
      el.style.pointerEvents = '';
      el.style.visibility = '';
      el.style.userSelect = '';
    });
    videoListEl.style.overflow = '';
    explorerEl.style.overflow = '';
  }

  // Wake lock helpers
  let wakeLock = null;
  async function requestWakeLock(){
    try{
      if('wakeLock' in navigator){ wakeLock = await navigator.wakeLock.request('screen'); wakeLock.addEventListener('release', ()=>{ wakeLock = null; }); }
    }catch(e){ }
  }
  async function releaseWakeLock(){ try{ if(wakeLock){ await wakeLock.release(); wakeLock = null; } }catch(e){} }

  // Notification helpers with extra checks
  function isInAppBrowser(){ const ua = navigator.userAgent || ''; return /FBAN|FBAV|Instagram|wv|WebView|FB_IAB|Twitter|Pinterest|Line/i.test(ua); }
  function isiOS(){ return /iP(hone|od|ad)/i.test(navigator.userAgent); }
  function iOSVersion(){ const m = navigator.userAgent.match(/OS (\d+)_?(\d+)?/); if(!m) return null; return parseFloat(`${m[1]}.${m[2] || 0}`); }

  function showEnableInstructions(){ let msg = 'Les notifications sont bloquées pour ce site.\n\n'; if(navigator.userAgent.includes('Android')){ msg += 'Chrome Android: Menu → Paramètres du site → Notifications → autoriser.\n'; } else if(isiOS()){ msg += 'iOS: ouvre Réglages → Safari → Notifications (ou ouvre le site dans Safari et utilise les options d’affichage). Ajoute à l’écran d’accueil si besoin.\n'; } else { msg += 'Vérifie Paramètres du navigateur → Notifications → autoriser pour ce site.\n'; } msg += '\nSi tu es dans un navigateur intégré (Facebook/Instagram), ouvre le site dans Chrome ou Safari.'; alert(msg); }

  function showNotifPromptIfNeeded(){
    try{
      const asked = localStorage.getItem('tf_notif_asked_v2');
      if((!('Notification' in window)) || (Notification && Notification.permission === 'granted')) return;
      if(asked) return;
      if(isiOS()){
        const v = iOSVersion();
        if(v && v < 16.4){
          document.getElementById('notifRequestHint').textContent =
            'iOS ancienne version — la réception des notifications web peut ne pas être supportée. Mets à jour iOS ou ouvre dans Safari/ajoute à l’écran d’accueil.';
        } else {
          document.getElementById('notifRequestHint').textContent =
            'Pour iOS : il se peut que tu doives "Ajouter à l’écran d’accueil" pour recevoir certaines notifications.';
        }
      }
      notifRequestEl.style.display = 'flex';
      notifRequestEl.setAttribute('aria-hidden','false');
    }catch(e){}
  }
  function hideNotifRequest(){ notifRequestEl.style.display = 'none'; notifRequestEl.setAttribute('aria-hidden','true'); localStorage.setItem('tf_notif_asked_v2','1'); }

  async function requestNotificationPermission(platform){
    try{
      localStorage.setItem('tf_notif_asked_v2','1');
      notifRequestEl.style.display = 'none';
      if(!('Notification' in window)){ alert('Notifications non supportées par ce navigateur.'); return; }
      if(isInAppBrowser()){ alert('Les notifications ne fonctionnent souvent pas dans les navigateurs intégrés (Facebook, Instagram, etc.). Ouvre le site dans Chrome/Edge/Safari pour activer les notifications.'); return; }
      if(Notification.permission === 'denied'){ showEnableInstructions(); return; }
      const result = await Notification.requestPermission();
      if(result === 'granted'){ try{ sendImmediateNotification(); }catch(e){} alert('Notifications activées.'); } else if(result === 'denied'){ alert('Notifications refusées — tu peux les activer depuis les réglages du navigateur.'); } else { showNotifPromptIfNeeded(); }
    }catch(e){}
  }

  async function sendImmediateNotification(){
    try{
      const arr = (window.allData||[]).filter(it=>{ const c=(it.Catégorie||it.category||'').toString().toLowerCase(); return c && c!=='poste'; });
      if(!arr || arr.length===0) return;
      const item = arr[Math.floor(Math.random()*arr.length)];
      const title = item && (item.Titre||item.Name) ? `TF-Stream vous propose ${item.Titre||item.Name}` : 'TF-Stream';
      const body = item && (item.Description||item.Bio) ? (item.Description||item.Bio).slice(0,120) : 'Cliquez pour découvrir.';
      const image = item && (item['Url Thumb']||item.thumb) ? new URL(item['Url Thumb']||item.thumb, location.origin).href : undefined;
      const slug = item && item.__slug ? item.__slug : undefined;
      const payload = { title, body, image, icon: image || undefined, badge: '/asset/192.png', tag: 'tfstream-welcome', data: { slug } };
      if(navigator.serviceWorker && navigator.serviceWorker.controller){ navigator.serviceWorker.controller.postMessage({ type:'SHOW_NOTIFICATION', payload }); } else { try{ new Notification(payload.title, { body: payload.body, icon: payload.icon, image: payload.image, badge: payload.badge, data: payload.data }); }catch(e){} }
    }catch(e){}
  }

  // small polyfills / helper exposure
  window._tf_refreshData = refreshData;

</script>
<script type='text/javascript' src='//pantherinvincible.com/64/68/83/6468839024f881b57715852274ce968b.js'></script>
</body>
</html>
